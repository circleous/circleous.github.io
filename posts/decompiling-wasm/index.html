<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Decompiling WASM | circleous</title><link rel=stylesheet href=/css/main.min.480e0ef6c6aac53eaf38419259058419b9323d67397f61cf2d8ce892d869c560.css integrity="sha256-SA4O9saqxT6vOEGSWQWEGbkyPWc5f2HPLYzokthpxWA=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>Decompiling WASM</h1><time datetime=2024-08-19T00:00:00+07:00>August 19, 2024</time></header><h2 id=the-problem>The Problem</h2><p>Have you ever looked at WASM decompiled code using <code>wasm2c</code> from wabt toolkit and thought, &ldquo;there has to be a better way&rdquo;?
While WASM&rsquo;s instruction set keeps things simple (except for those vectors and floating-point numbers!),
the stack machine design can sometimes lead to less-than-optimal code after decompilation.</p><p>Take a look at this code snippet: (taken from revsite2 challenge LITCTF 2024)</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#bb9af7>static</span> <span style=color:#41a6b5>void</span> <span style=color:#7aa2f7>w2c_visit_ad</span>(Z_revsite2_instance_t<span style=color:#9ece6a;font-weight:700>*</span> instance) {
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// [SNIP]
</span></span></span><span style=display:flex><span>  FUNC_PROLOGUE;
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/* push rbp */</span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/* mov rbp, rsp */</span>
</span></span><span style=display:flex><span>  u32 w2c_i0, w2c_i1, w2c_i2;
</span></span><span style=display:flex><span>  u64 w2c_j0, w2c_j1;
</span></span><span style=display:flex><span>  w2c_i0 <span style=color:#9ece6a;font-weight:700>=</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_g0;
</span></span><span style=display:flex><span>  w2c_l0 <span style=color:#9ece6a;font-weight:700>=</span> w2c_i0;
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>/* sub rsp, N */</span>
</span></span><span style=display:flex><span>  w2c_i0 <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>2048u</span>;
</span></span><span style=display:flex><span>  w2c_l1 <span style=color:#9ece6a;font-weight:700>=</span> w2c_i0;
</span></span><span style=display:flex><span>  w2c_i0 <span style=color:#9ece6a;font-weight:700>=</span> w2c_l0;
</span></span><span style=display:flex><span>  w2c_i1 <span style=color:#9ece6a;font-weight:700>=</span> w2c_l1;
</span></span><span style=display:flex><span>  w2c_i0 <span style=color:#9ece6a;font-weight:700>-=</span> w2c_i1;
</span></span><span style=display:flex><span>  w2c_l2 <span style=color:#9ece6a;font-weight:700>=</span> w2c_i0;
</span></span><span style=display:flex><span>  w2c_i0 <span style=color:#9ece6a;font-weight:700>=</span> w2c_l2;
</span></span><span style=display:flex><span>  instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_g0 <span style=color:#9ece6a;font-weight:700>=</span> w2c_i0;
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// [SNIP]
</span></span></span></code></pre></div><p>This might look familiar if you&rsquo;ve dabbled in C/C++ before. It&rsquo;s just a standard function prologue, but thanks to WASM&rsquo;s design,
it ends up a bit bloated. What could potentially be a single instruction gets broken down into multiple steps.
It&rsquo;s readable, sure, but not exactly optimized.</p><h2 id=the-compilers-magic-touch>The Compiler&rsquo;s Magic Touch</h2><p>This is where the beauty of compilers comes in. Just like with any other code,
we can use tools like <code>gcc</code> or <code>clang</code> with their handy <code>-O</code> flag to optimize our C code from WASM decompiler.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pacman -S wabt
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># convert wasm to c with wabt toolkit wasm2c</span>
</span></span><span style=display:flex><span>wasm2c file.wasm -o file.c
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># wasm-c runtime api</span>
</span></span><span style=display:flex><span>git clone https://github.com/WebAssembly/wasm-c-api
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># -O3 max optimization, -g include wasm2c structs, wasm-rt-impl for default wasm runtime implementations</span>
</span></span><span style=display:flex><span>gcc -g <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -O3 <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -I ./wasm-c-api/include <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -I . <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    -I /usr/share/wabt/wasm2c <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    /usr/share/wabt/wasm2c/wasm-rt-impl.c <span style=color:#7aa2f7>\
</span></span></span><span style=display:flex><span>    file.c
</span></span></code></pre></div><p>and after loading the compiled binary to IDA, we get a very clean and optimized output.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#41a6b5>void</span> <span style=color:#bb9af7>__fastcall</span> <span style=color:#7aa2f7>Z_revsite2Z_visit_ad</span>(Z_revsite2_instance_t <span style=color:#9ece6a;font-weight:700>*</span>instance)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// [SNIP]
</span></span></span><span style=display:flex><span>  rbp <span style=color:#9ece6a;font-weight:700>=</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_g0;
</span></span><span style=display:flex><span>  rsp <span style=color:#9ece6a;font-weight:700>=</span> rbp <span style=color:#9ece6a;font-weight:700>-</span> <span style=color:#e0af68>2048</span>;
</span></span><span style=display:flex><span>  instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_g0 <span style=color:#9ece6a;font-weight:700>=</span> rsp;
</span></span><span style=display:flex><span>  <span style=color:#9ece6a;font-weight:700>*&amp;</span>instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data[rsp <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>2040</span>] <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>score <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data) <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>123456789</span>;
</span></span><span style=display:flex><span>  <span style=color:#bb9af7>if</span> ( <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>chksum <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data) <span style=color:#9ece6a;font-weight:700>==</span> <span style=color:#9ece6a;font-weight:700>*&amp;</span>instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data[rsp <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>2040</span>] )
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#9ece6a;font-weight:700>++*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>chksum <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data);
</span></span><span style=display:flex><span>    <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>chksum2 <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data) <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#e0af68>3</span>
</span></span><span style=display:flex><span>                                             <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>score <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data)
</span></span><span style=display:flex><span>                                             <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>score <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data)
</span></span><span style=display:flex><span>                                             <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>5</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>score <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data)
</span></span><span style=display:flex><span>                                             <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>3</span>;
</span></span><span style=display:flex><span>    <span style=color:#9ece6a;font-weight:700>*</span>(<span style=color:#9ece6a;font-weight:700>&amp;</span>key <span style=color:#9ece6a;font-weight:700>+</span> instance<span style=color:#9ece6a;font-weight:700>-&gt;</span>w2c_memory.data) <span style=color:#9ece6a;font-weight:700>+=</span> <span style=color:#e0af68>3</span>
</span></span><span style=display:flex><span>  <span style=color:#414868;font-style:italic>// [SNIP]
</span></span></span></code></pre></div><div><div>Tags:</div><ul><li><a href=/tags/wasm/>Wasm</a></li><li><a href=/tags/rev/>Rev</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>