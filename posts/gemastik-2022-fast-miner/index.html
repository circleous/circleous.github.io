<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Gemastik 2022 - Fast Miner | circleous</title><link rel=stylesheet href=/css/main.min.a16339a5d57f8df4724d41efd02e48d0023feb1e3934721f39cbdc1bb1a12b31.css integrity="sha256-oWM5pdV/jfRyTUHv0C5I0AI/6x45NHIfOcvcG7GhKzE=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>Gemastik 2022 - Fast Miner</h1><time datetime=2022-10-29T00:00:00+07:00>October 29, 2022</time></header><p>Ide awal dari soal ini sederhana sebenernya buat <em>aware</em> orang tentang Bitcoin block hash. Bitcoin block hash ini punya satu karakteristik dimana hasil double hash (SHA-256) dari block header harus memiliki beberapa bit nol di belakangnya sebagai bentuk <em>Proof-of-Work</em>. Ide ini sebenernya lebih cocok untuk jadi soal misc-cryptography, <em>but here we are</em> :p</p><p>Ide penggunaan bitcoin block hash ini sudah ada di beberapa CTF sebelumnya, i.e.</p><ul><li><a href=https://ctftime.org/task/14014>Bit Flip 3 - Dragon CTF 2020</a></li><li><a href=https://github.com/HITB-CyberWeek/hitbsecconf-ctf-2022/tree/main/writeups/kv>kv - HITB SECCONF CTF 2022</a></li></ul><h2 id=ringkasan-soal>Ringkasan Soal</h2><blockquote><p>source code bisa diakses di <a href=https://gist.github.com/circleous/a97be308540c9163592a540750456589#file-main-py>https://gist.github.com/circleous/a97be308540c9163592a540750456589#file-main-py</a></p></blockquote><ul><li><code>GET /</code> (mulai session baru untuk dapetin UID)</li><li><code>GET /notes?title=...</code> (cari notes berdasarkan title)</li><li><code>POST /notes</code> <code>title=...&amp;content=....</code> (buat notes baru)</li></ul><p>Skema penyimpanan notes menggunakan plain dictionary dimana untuk key-nya menggunakan 8 trailing bytes hasil dari SHA256(UID + title). Jadi untuk dapetin flagnya cukup <em>straightforward</em> dengan <em><strong>cukup</strong></em> cari hash dengan 8 trailing zero bytes karena sudah ada flag pada key 00â€¦000 dimana Bitcoin block hash sudah lebih dari mencukupi untuk kebutuhan tersebut.</p><h2 id=solve>Solve</h2><p>Bitcoin chain data itu besar, jadi ga perlu download seluruh datanya. Cukup pakai block explorer api dan simpan beberapa hash dari block data yang bisa digunakan untuk tahap selanjutnya,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>get_block_data</span>(num<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>25</span>) <span style=color:#9ece6a;font-weight:700>-&gt;</span> Dict[<span style=color:#9ece6a>bytes</span>, <span style=color:#9ece6a>bytes</span>]:
</span></span><span style=display:flex><span>    latest_block <span style=color:#9ece6a;font-weight:700>=</span> requests<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9ece6a>&#34;https://blockchain.info/q/latesthash&#34;</span>)<span style=color:#9ece6a;font-weight:700>.</span>text
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    cur_block <span style=color:#9ece6a;font-weight:700>=</span> latest_block
</span></span><span style=display:flex><span>    res <span style=color:#9ece6a;font-weight:700>=</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>for</span> _ <span style=color:#9ece6a;font-weight:700>in</span> <span style=color:#9ece6a>range</span>(num):
</span></span><span style=display:flex><span>        resp <span style=color:#9ece6a;font-weight:700>=</span> requests<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9d7cd8>f</span><span style=color:#9ece6a>&#34;https://blockchain.info/rawblock/</span><span style=color:#9ece6a>{</span>cur_block<span style=color:#9ece6a>}</span><span style=color:#9ece6a>&#34;</span>,
</span></span><span style=display:flex><span>                            params<span style=color:#9ece6a;font-weight:700>=</span>{<span style=color:#9ece6a>&#34;format&#34;</span>: <span style=color:#9ece6a>&#34;hex&#34;</span>})
</span></span><span style=display:flex><span>        block_data <span style=color:#9ece6a;font-weight:700>=</span> resp<span style=color:#9ece6a;font-weight:700>.</span>text
</span></span><span style=display:flex><span>        header <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>bytes</span><span style=color:#9ece6a;font-weight:700>.</span>fromhex(block_data[:<span style=color:#e0af68>160</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        h <span style=color:#9ece6a;font-weight:700>=</span> sha256(header)
</span></span><span style=display:flex><span>        <span style=color:#9ece6a>hash</span> <span style=color:#9ece6a;font-weight:700>=</span> h<span style=color:#9ece6a;font-weight:700>.</span>digest()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#414868;font-style:italic># store data</span>
</span></span><span style=display:flex><span>        res[<span style=color:#9ece6a>hash</span>[:<span style=color:#e0af68>2</span>]] <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>hash</span>[<span style=color:#e0af68>2</span>:]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#414868;font-style:italic># reverse the byte order</span>
</span></span><span style=display:flex><span>        prev_block <span style=color:#9ece6a;font-weight:700>=</span> header[<span style=color:#e0af68>35</span>:<span style=color:#e0af68>3</span>:<span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span>]<span style=color:#9ece6a;font-weight:700>.</span>hex()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#414868;font-style:italic># change cur_block to prev_block for the next iteration</span>
</span></span><span style=display:flex><span>        cur_block <span style=color:#9ece6a;font-weight:700>=</span> prev_block
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> res
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>main</span>():
</span></span><span style=display:flex><span>    block <span style=color:#9ece6a;font-weight:700>=</span> get_block_data(<span style=color:#e0af68>12</span>)
</span></span><span style=display:flex><span><span style=color:#9ece6a;font-weight:700>...</span>
</span></span></code></pre></div><p>karena block data yang di dapat tidak banyak perlu sedikit brute untuk mendapatkan UID yang cocok lalu baru bisa dapat flagnya.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>get_uid</span>() <span style=color:#9ece6a;font-weight:700>-&gt;</span> Tuple[<span style=color:#9ece6a>str</span>, <span style=color:#9ece6a>bytes</span>]:
</span></span><span style=display:flex><span>    resp <span style=color:#9ece6a;font-weight:700>=</span> requests<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9ece6a>&#34;http://localhost:8000&#34;</span>)
</span></span><span style=display:flex><span>    uid <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>bytes</span><span style=color:#9ece6a;font-weight:700>.</span>fromhex(resp<span style=color:#9ece6a;font-weight:700>.</span>text<span style=color:#9ece6a;font-weight:700>.</span>split()[<span style=color:#9ece6a;font-weight:700>-</span><span style=color:#e0af68>1</span>][:<span style=color:#e0af68>4</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> resp<span style=color:#9ece6a;font-weight:700>.</span>cookies<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9ece6a>&#34;sessionId&#34;</span>), uid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>main</span>():
</span></span><span style=display:flex><span>	<span style=color:#9ece6a;font-weight:700>...</span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>while</span> <span style=color:#e0af68>True</span>:
</span></span><span style=display:flex><span>        sessionId, uid <span style=color:#9ece6a;font-weight:700>=</span> get_uid()
</span></span><span style=display:flex><span>        title <span style=color:#9ece6a;font-weight:700>=</span> block<span style=color:#9ece6a;font-weight:700>.</span>get(uid)
</span></span><span style=display:flex><span>        <span style=color:#bb9af7>if</span> title <span style=color:#9ece6a;font-weight:700>is</span> <span style=color:#9ece6a;font-weight:700>not</span> <span style=color:#e0af68>None</span>:
</span></span><span style=display:flex><span>            <span style=color:#bb9af7>break</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>assert</span> sha256(uid <span style=color:#9ece6a;font-weight:700>+</span> title)<span style=color:#9ece6a;font-weight:700>.</span>hexdigest()<span style=color:#9ece6a;font-weight:700>.</span>endswith(<span style=color:#9ece6a>&#34;0000000000000000&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resp <span style=color:#9ece6a;font-weight:700>=</span> requests<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9ece6a>&#34;http://localhost:8000/notes&#34;</span>,
</span></span><span style=display:flex><span>                        cookies<span style=color:#9ece6a;font-weight:700>=</span>{<span style=color:#9ece6a>&#34;sessionId&#34;</span>: sessionId},
</span></span><span style=display:flex><span>                        params<span style=color:#9ece6a;font-weight:700>=</span>{<span style=color:#9ece6a>&#34;title&#34;</span>: title})
</span></span><span style=display:flex><span>    <span style=color:#9ece6a>print</span>(resp<span style=color:#9ece6a;font-weight:700>.</span>text) <span style=color:#414868;font-style:italic># flag</span>
</span></span></code></pre></div><h2 id=the-pitfall-and-unreleased-part-of-the-challenge>The Pitfall and Unreleased Part of the Challenge</h2><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>notes: Dict[<span style=color:#9ece6a>str</span>, <span style=color:#9ece6a>str</span>] <span style=color:#9ece6a;font-weight:700>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#9ece6a>&#34;00000000&#34;</span>: os<span style=color:#9ece6a;font-weight:700>.</span>environ<span style=color:#9ece6a;font-weight:700>.</span>get(<span style=color:#9ece6a>&#34;FLAG&#34;</span>, <span style=color:#9ece6a>&#34;FLAG</span><span style=color:#9ece6a>{test_flag}</span><span style=color:#9ece6a>&#34;</span>),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Jadi 8 trailing bytes ini bukan tanpa sebab karena eksekusi awal dari ide soal ini memakai dotnet core dimana UID tidak diberikan dan perlu di overwrite terlebih dahulu dengan menggunakan UAF di stack allocation, tapi karena sampai beberapa jam sebelum lomba dimulai remote exploit belum bisa dan gagal terus, akhirnya saya speedrun untuk rewrite ke python saja dan lupa menaikkan difficulty dari PoW xD.</p><hr><p>solver dan soal bisa diakses di <a href=https://gist.github.com/circleous/a97be308540c9163592a540750456589>https://gist.github.com/circleous/a97be308540c9163592a540750456589</a></p><div><div>Tags:</div><ul><li><a href=/tags/ctf-writeup/>Ctf-Writeup</a></li><li><a href=/tags/editorial/>Editorial</a></li><li><a href=/tags/web/>Web</a></li><li><a href=/tags/crypto/>Crypto</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>